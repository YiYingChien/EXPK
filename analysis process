#at EXPK/analysis
do at non conda environment at early time, later do at conda base environment
-----------------------------------------------trimmomatic------------------------------------------------
#bash
cd ../ExpKRNA/rawData/
ls | grep R1 | sed 's/^/\.\.\/ExpKRNA\/rawData\//g'>../../analysis/R1_list
ls | grep R2 | sed 's/^/\.\.\/ExpKRNA\/rawData\//g'>../../analysis/R2_list
mkdir paired
mkdir unpaired

cd ../../analysis
head R1_list >test_R1_list 
head R2_list >test_R2_list 

#/home/yee/jdk-23.0.1/bin/java -jar ../../usr/bin/trimmomatic.jar PE -threads 70 -phred33 ../ExpKRNA/rawData/K10-K15-F1_22CWMVLT4_R1.fastq.gz ../ExpKRNA/rawData/K10-K15-F1_22CWMVLT4_R2.fastq.gz K10-K15-F1_22CWMVLT4_R1_paired.fastq.gz K10-K15-F1_22CWMVLT4_R2_paired.fastq.gz K10-K15-F1_22CWMVLT4_R1_unpaired.fastq.gz K10-K15-F1_22CWMVLT4_R2_unpaired.fastq.gz ILLUMINACLIP:../../trimmomatic-master/adapters/TruSeq3-PE.fa:2:30:10:2:True LEADING:3 TRAILING:3 MINLEN:36

#cat test_R1_list | sed 's/R1/R1_paired/g' | sed 's/rawData/paired/g'>test_R1_paired_list
#cat test_R2_list | sed 's/R2/R2_paired/g' | sed 's/rawData/paired/g'>test_R2_paired_list
#cat test_R1_list | sed 's/R1/R1_unpaired/g' | sed 's/rawData/unpaired/g'>test_R1_unpaired_list
#cat test_R2_list | sed 's/R2/R2_unpaired/g' | sed 's/rawData/unpaired/g'>test_R2_unpaired_list

#!/bin/bash
#test_R1=()
#test_R2=()
#test_R1_paired=()
#test_R2_paired=()
#test_R1_unpaired=()
#test_R2_unpaired=()
#while IFS= read -r line;
# do test_R1+=("$line") 
#done < test_R1_list
#while IFS= read -r line; 
#do test_R2+=("$line")
# done < test_R2_list 
#while IFS= read -r line; 
#do test_R1_paired+=("$line") 
#done < test_R1_paired_list
#while IFS= read -r line;
# do test_R2_paired+=("$line") 
#done < test_R2_paired_list 
#while IFS= read -r line; 
#do test_R1_unpaired+=("$line")
# done < test_R1_unpaired_list 
#while IFS= read -r line; 
#do test_R2_unpaired+=("$line") 
#done < test_R2_unpaired_list

for i in $(seq 0 $((${#test_R1[@]}-1))); 
do arg1="${test_R1[$i]}" arg2="${test_R2[$i]}" arg3="${test_R1_paired[$i]}" arg4="${test_R2_paired[$i]}" arg5="${test_R1_unpaired[$i]}" arg6="${test_R2_unpaired[$i]}" 
/home/yee/jdk-23.0.1/bin/java -jar ../../usr/bin/trimmomatic.jar PE -threads 70 -phred33 $arg1 $arg2 $arg3 $arg4 $arg5 $arg6 ILLUMINACLIP:../../trimmomatic-master/adapters/TruSeq3-PE.fa:2:30:10:2:True LEADING:3 TRAILING:3 MINLEN:36
done

cat R1_list | sed 's/R1/R1_paired/g' | sed 's/rawData/paired/g'>R1_paired_list
cat R2_list | sed 's/R2/R2_paired/g' | sed 's/rawData/paired/g'>R2_paired_list
cat R1_list | sed 's/R1/R1_unpaired/g' | sed 's/rawData/unpaired/g'>R1_unpaired_list
cat R2_list | sed 's/R2/R2_unpaired/g' | sed 's/rawData/unpaired/g'>R2_unpaired_list

#!/bin/bash
R1=()
R2=()
R1_paired=()
R2_paired=()
R1_unpaired=()
R2_unpaired=()
while IFS= read -r line;
 do R1+=("$line") 
done < R1_list
while IFS= read -r line; 
do R2+=("$line")
 done < R2_list 
while IFS= read -r line; 
do R1_paired+=("$line") 
done < R1_paired_list
while IFS= read -r line;
 do R2_paired+=("$line") 
done < R2_paired_list 
while IFS= read -r line; 
do R1_unpaired+=("$line")
 done < R1_unpaired_list 
while IFS= read -r line; 
do R2_unpaired+=("$line") 
done < R2_unpaired_list

for i in $(seq 0 $((${#R1[@]}-1))); 
do arg1="${R1[$i]}" arg2="${R2[$i]}" arg3="${R1_paired[$i]}" arg4="${R1_unpaired[$i]}" arg5="${R2_paired[$i]}" arg6="${R2_unpaired[$i]}" 
/home/yee/jdk-23.0.1/bin/java -jar ../../usr/bin/trimmomatic.jar PE -threads 70 -phred33 $arg1 $arg2 $arg3 $arg4 $arg5 $arg6 ILLUMINACLIP:../../trimmomatic-master/adapters/TruSeq3-PE.fa:2:30:10:2:True LEADING:3 TRAILING:3 MINLEN:36
done
#bash
-----------------------------------------------fastqc and multiqc-----------------------------------------
#conda
conda create --name multiQc python=3.11
conda activate multiQc
conda install multiqc
#conda
#bash
ls ../ExpKRNA/paired/ | grep gz | sed 's/^/\.\.\/ExpKRNA\/paired\//g' | sed -n -e 'H;${x;s/\n/ /g;p;}'>paired_list
while IFS= read -r file;
do fastqc -t 72 $file -o ../ExpKRNA/paired/
done<paired_list

mkdir fastqc
mkdir fastqc_report
mv *.html ./fastqc_report/
mv *.zip fastqc
#bash
#conda
multiqc ../ExpKRNA/paired/fastqc -o ../ExpKRNA/paired/
#conda
-------------------------------------------------------trinity--------------------------------------------------
#bash
ls ../ExpKRNA/rawData/ | grep .gz | sed 's/_R[12].fastq.gz/_trinity/' | sed 's/^/trinity\//' |sort |uniq > sample_ID
#Trinity --seqType fq --max_memory 500G \
         --left ../ExpKRNA/paired/K10-K15-F1_22CWMVLT4_R1_paired.fastq.gz \
         --right ../ExpKRNA/paired/K10-K15-F1_22CWMVLT4_R2_paired.fastq.gz \
         --CPU 36 

#Trinity --seqType fq --max_memory 500G \
         --left ../ExpKRNA/paired/K10-K15-F1_22CWMVLT4_R1_paired.fastq.gz \
         --right ../ExpKRNA/paired/K10-K15-F1_22CWMVLT4_R2_paired.fastq.gz \
         --CPU 36 \
--output trinity /K10-K15-F1_22CWMVLT4_trinity

while IFS= read -r line; 
do ID+=("$line") 
done < sample_ID

for i in $(seq 0 $((${#R1_paired[@]}-1))); 
do arg1="${R1_paired[$i]}" arg2="${R2_paired[$i]}" arg3="${ID[$i]}" 
Trinity --seqType fq --max_memory 200G --left $arg1 --right $arg2 --CPU 72 --output $arg3
done


#Trinity --seqType fq --max_memory 200G \ --left ../ExpKRNA/paired/K49-K55-F1_22CWMVLT4_R1_paired.fastq.gz \ --right ../ExpKRNA/paired/K49-K55-F1_22CWMVLT4_R2_paired.fastq.gz \ --CPU 72 \ --output trinity/K49-K55-F1_22CWMVLT4_trinity
---------------------------------------------------bowtie2---------------------------------------------------
cat sample_ID |sed 's/trinity\///'| sed 's/_trinity//'>index_list
cat sample_ID | sed 's/_trinity/_trinity.Trinity.fasta/'>bowtie2_fasta_input
while IFS= read -r line; 
do bowtie2_input+=("$line") 
done <bowtie2_fasta_input
while IFS= read -r line; 
do bowtie2_index+=("$line") 
done <index_list
for i in $(seq 0 $((${#bowtie2_input[@]}-1))); 
do arg1="${bowtie2_input[$i]}" arg2="${bowtie2_index[$i]}"  
bowtie2-build $arg1 $arg2
done

cat index_list | sed -e 's/^/bowtie2\//' -e's/$/.bam/'>bam_list
cat index_list | sed -e's/$/_align_stats.txt/'> align_stats_list
while IFS= read -r line; 
do bam+=("$line") 
done <bam_list
while IFS= read -r line; 
do align_stats+=("$line") 
done <align_stats_list
for i in $(seq 0 $((${#bowtie2_index[@]}-1))); 
do arg1="${bowtie2_index[$i]}" arg2="${R1_paired[$i]}" arg3="${R2_paired[$i]}" arg4="${align_stats[$i]}" arg5="${bam[$i]}" 
bowtie2 -p 72 -q --no-unal -k 20 -x $arg1 -1 $arg2 -2 $arg3  \
     2>$arg4| samtools view -@72 -Sb -o $arg5
done

---------------------------------------------------RSEM---------------------------------------------------
conda install -n base -c conda-forge mamba

#not use
conda create --name rnaquast
conda activate rnaquast
mamba install rnaquast
mamba install bioconda::busco
conda create --name RSEM 
mamba install bioconda::rsem
#not use

for file in "${bam[@]}" 
do 
	sorted_file="${file%.bam}_sorted.bam"
	samtools sort -n -@ 72 "$file" -o "$sorted_file"
done


#conda
#not use in further analysis
conda activate RSEM
for i in $(seq 0 $((${#bowtie2_index[@]}-1))); 
do
rsem-prepare-reference -p 72 --bowtie2 "${bowtie2_input[$i]}" --transcript-to-gene-map "${bowtie2_input[$i]#bowtie2}.gene_trans_map" "RSEM${bowtie2_index[$i]#bowtie2}_rsem_reference"
done

for i in $(seq 0 $((${#bowtie2_index[@]}-1))); 
do
	rsem-calculate-expression -p 72 --bam --paired-end "${bam[$i]%.bam}_sorted.bam" "RSEM${bowtie2_index[$i]#bowtie2}_rsem_reference" "RSEM${bowtie2_index[$i]#bowtie2}_rsem_output"
done
conda deactivate
#not use in further analysis

#base 
for i in $(seq 0 $((${#bowtie2_input[@]}-1)));  
do align_and_estimate_abundance.pl --thread_count 72 --seqType fq --seqType fq --left "${R1_paired[$i]}" --right "${R2_paired[$i]}" --transcripts "${bowtie2_input[$i]}" --est_method RSEM --aln_method bowtie --gene_trans_map "${bowtie2_input[$i]}.gene_trans_map" --trinity_mode --prep_reference --output_dir ./transcript_abundance --output_prefix ${bowtie2_index[$i]#bowtie2/}; 
done
-----------------------------------------------infernal and Rfam------------------------------------------
mamba install bioconda::infernal
cd
mkdir Rfam
mv *.cm ./Rfam
wget https://ftp.ebi.ac.uk/pub/databases/Rfam/CURRENT/Rfam.tar.gz
tar -zxf Rfam.tar.gz
wget https://ftp.ebi.ac.uk/pub/databases/Rfam/15.0/Rfam.cm.gz
gunzip Rfam.cm.gz
wget https://ftp.ebi.ac.uk/pub/databases/Rfam/CURRENT/Rfam.clanin
mv Rfam.clanin Rfam.cm ./Rfam
wget https://ftp.ebi.ac.uk/pub/databases/Rfam/CURRENT/database_files/family.txt.gz
gunzip family.txt.gz
mv family.txt ./Rfam
cd /EXPK/analysis
cmpress ../../Rfam/Rfam.cm
mamba install bioconda::easel

for file in "${bowtie2_input[@]}"
do
	esl-seqstat "$file" | grep "Total # residues" | cut -d " " -f 7 >>total_residues
done

mkdir infernal

paste total_residues index_list bowtie2_fasta_input | while IFS=$'\t' read -r f1 f2 f3;
do
cmscan -Z $(("$f1"*2/1000000)) --cut_ga --rfam --nohmmonly --tblout "infernal/$f2.tblout" --fmt 2 --cpu 72 --clanin ~/Rfam/Rfam.clanin ~/Rfam/Rfam.cm "$f3" > "infernal/$f2.cmscan" 
done;

#filtered.tblout has replicate ID not unique 
while IFS= read -r index;
do 
	grep -v "=" infernal/"${index}".tblout > infernal/"${index}"_filtered.tblout
done<index_list

#noncoding has replicate ID not unique
while IFS= read -r index;
do 
	grep "TRINITY" infernal/"${index}"_filtered.tblout | awk 'BEGIN{OFS="\t"} {print $4}' | sed -e "s/^/"${index}"_/"> infernal/"${index}"_noncoding
done<index_list

while IFS= read -r index;
do 
	echo "${index}"_noncoding
	sort infernal/"${index}"_noncoding |uniq | wc -l
done<index_list

#unique ID
#K10-K15-F1_22CWMVLT4_noncoding
#2374
#K10-K9-F2_22CWMVLT4_noncoding
#1321
#K17-K19-F2_22CWMVLT4_noncoding
#1469
#K1-K3-F2_22CWMVLT4_noncoding
#1912
#K20-K24-F2_22CWMVLT4_noncoding
#12468
#K20-K28-F1_22CWMVLT4_noncoding
#891
#K21-K25-F2_22CWMVLT4_noncoding
#467
#K25-K29-F1_22CWMVLT4_noncoding
#942
#K28-K29-F2_22CWMVLT4_noncoding
#512
#K2-K4-F2_22CWMVLT4_noncoding
#793
#K41-K42-F2_22CWMVLT4_noncoding
#1141
#K44-K47-F2_22CWMVLT4_noncoding
#799


wc -l trinity/*_re.fasta
    #389412 trinity/K10-K15-F1_22CWMVLT4_trinity.Trinity_re.fasta
    #511328 trinity/K10-K9-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #592240 trinity/K17-K19-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #977222 trinity/K1-K3-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #592816 trinity/K20-K24-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #411328 trinity/K20-K28-F1_22CWMVLT4_trinity.Trinity_re.fasta
    #410816 trinity/K21-K25-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #469612 trinity/K25-K29-F1_22CWMVLT4_trinity.Trinity_re.fasta
    #404576 trinity/K28-K29-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #627700 trinity/K2-K4-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #567798 trinity/K41-K42-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #684324 trinity/K44-K47-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #546608 trinity/K45-K53-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #727748 trinity/K49-K55-F1_22CWMVLT4_trinity.Trinity_re.fasta
    #159584 trinity/K4-K5-F1_22CWMVLT4_trinity.Trinity_re.fasta
    #733538 trinity/K50-K54-F1_22CWMVLT4_trinity.Trinity_re.fasta
    #563400 trinity/K52-K50-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #529254 trinity/K58-K60-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #573032 trinity/K59-K57-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #504920 trinity/K5-K7-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #561512 trinity/K61-K67-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #506678 trinity/K62-K56-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #564640 trinity/K64-K63-F2_22CWMVLT4_trinity.Trinity_re.fasta
    #600842 trinity/K70-K66-F2_22CWMVLT4_trinity.Trinity_re.fasta
  #13210928 total

#K10-K15-F1_22CWMVLT4:0.61%
#K10-K9-F2_22CWMVLT4:0.26%
#K17-K19-F2_22CWMVLT4:0.25%
#K1-K3-F2_22CWMVLT4:0.2%
#K20-K24-F2_22CWMVLT4:2.1%
#K20-K28-F1_22CWMVLT4:0.22%
#K21-K25-F2_22CWMVLT4:0.11%
#K25-K29-F1_22CWMVLT4:0.2%
#K28-K29-F2_22CWMVLT4:0.13%
#K2-K4-F2_22CWMVLT4:0.13%
#K41-K42-F2_22CWMVLT4:0.2%
#K44-K47-F2_22CWMVLT4:0.12%
#K45-K53-F2_22CWMVLT4:0.1%
#K49-K55-F1_22CWMVLT4:0.24%
#K4-K5-F1_22CWMVLT4:0.17%
#K50-K54-F1_22CWMVLT4:0.13%
#K52-K50-F2_22CWMVLT4:0.18%
#K58-K60-F2_22CWMVLT4:0.2%
#K59-K57-F2_22CWMVLT4:0.16%
#K5-K7-F2_22CWMVLT4:0.19%
#K61-K67-F2_22CWMVLT4:0.17%
#K62-K56-F2_22CWMVLT4:0.27%
#K64-K63-F2_22CWMVLT4:0.15%
#K70-K66-F2_22CWMVLT4:0.15%

while IFS= read -r index;
do 
	grep -v -F -f <(grep -w -A 1 -f infernal/"${index}"_noncoding trinity/"${index}"_trinity.Trinity_re.fasta) trinity/"${index}"_trinity.Trinity_re.fasta >trinity/"${index}"_trinity.Trinity_coding.fasta 
done<index_list

#for check
#while IFS= read -r index;
#do 
#echo "${index}"
#grep -wf infernal/"${index}"_noncoding #trinity/"${index}"_trinity.Trinity_re.fasta | wc -l
#sort infernal/"${index}"_noncoding | uniq | wc -l
#grep -w -A 1 -f infernal/"${index}"_noncoding #trinity/"${index}"_trinity.Trinity_re.fasta |grep -v "^--$"| wc -l
#wc -l trinity/"${index}"_trinity.Trinity_coding.fasta
#wc -l trinity/"${index}"_trinity.Trinity_re.fasta 
#done<index_list

#not used
------------------------------------------------MicroFisher --------------------------------------------
cd
conda create -n MicroFisher Python=3.12
conda activate MicroFisher
conda install bioconda::centrifuge
git clone https://github.com/NFREC-Liao-Lab/MicroFisher.git
cd MicroFisher/microfisher
pip3 install -r requirements.txt
pip3 install .
MicroFisher init_db

cd ~/EXPK/analysis/
mkdir microfisher

while IFS= read -r line;
do 
	ln "$line" "./microfisher${line#../ExpKRNA/paired}"
done<R1_paired_list

while IFS= read -r line;
do 
	ln "$line" "./microfisher${line#../ExpKRNA/paired}"
done<R2_paired_list

paste R1_paired_list R2_paired_list index_list| while IFS=$'\t' read -r f1 f2 f3;
do
	MicroFisher preset --preset_db LSU --db_path /home/yee/MicroFisher/microfisher/default_db --min 120 --workspace microfisher --paired "${f1#../ExpKRNA/paired/}" "${f2#../ExpKRNA/paired/}" --out_dir microfisher_output --out_prefix "$f3" --threads 72
done

cd /microfisher/microfisher_output 
ls | grep _report.tsv > report_list
xargs cat < report_list | grep -v name | sort > total_output

#check
MicroFisher preset --preset_db LSU --db_path /home/yee/MicroFisher/microfisher/default_db --min 120 --workspace microfisher --paired K10-K15-F1_22CWMVLT4_R1_paired.fastq.gz K10-K15-F1_22CWMVLT4_R2_paired.fastq.gz --out_dir retest --out_prefix K10-K15-F1_22CWMVLT4 --threads 72
MicroFisher preset --preset_db LSU --db_path /home/yee/MicroFisher/microfisher/default_db --min 120 --workspace ../ExpKRNA/paired/ --paired K10-K15-F1_22CWMVLT4_R1_paired.fastq.gz K10-K15-F1_22CWMVLT4_R2_paired.fastq.gz --out_dir retest --out_prefix K10-K15-F1_22CWMVLT4 --threads 72

#modified from chatgpt, not used
--------------------------------------------longest transcript------------------------------------
mamba install conda-forge::parallel
#!/bin/bash

process_file() {
    filename="$1"

    # 確保檔案存在
    if [[ ! -f "$filename" ]]; then
        echo "檔案 $filename 不存在，跳過..."
        return
    fi

    # 取得輸出檔名前綴
    output_prefix=$(echo "$filename" | sed 's/_trinity\.Trinity\.fasta\.gene_trans_map//')

    # 初始化變數
    tmp_gene=""
    declare -A seen_genes
    rep_gene=()
    uni_gene=()

    # 讀取檔案內容
    while IFS= read -r line; do
        gene=$(echo "$line" | cut -f1)

        if [[ -z "$tmp_gene" ]]; then
            tmp_gene="$gene"
            continue
        fi

        if [[ "$tmp_gene" == "$gene" ]]; then
            seen_genes["$gene"]=1
        else
            if [[ -z "${seen_genes[$tmp_gene]}" ]]; then
                uni_gene+=("$tmp_gene")
            else
                rep_gene+=("$tmp_gene")
            fi
            tmp_gene="$gene"
        fi
    done < "$filename"

    # 檢查最後一個基因
    if [[ -n "$tmp_gene" && -z "${seen_genes[$tmp_gene]}" ]]; then
        uni_gene+=("$tmp_gene")
    elif [[ -n "$tmp_gene" ]]; then
        rep_gene+=("$tmp_gene")
    fi

    # 寫入輸出檔案
    printf "%s\n" "${rep_gene[@]}" > "${output_prefix}_rep_gene"
    printf "%s\n" "${uni_gene[@]}" > "${output_prefix}_uni_gene"

    echo "完成處理: ${output_prefix}_rep_gene 和 ${output_prefix}_uni_gene"
}

export -f process_file  # 讓 `parallel` 能夠調用函數

# 並行處理所有檔案，每次最多使用 72 個核心
cat bowtie2_fasta_input | sed 's/\.fasta/\.fasta\.gene_trans_map/'| parallel -j 72 process_file {}

cat bowtie2_fasta_input|sed 's/_trinity.Trinity.fasta/_uni_gene/'>uni_gene
cat bowtie2_fasta_input|sed 's/_trinity.Trinity.fasta/_rep_gene/'>rep_gene

while IFS= read -r index;
do  
	sed -E "s/>/>"$index"_/g" "trinity/${index}_trinity.Trinity.fasta"| sed -E ':a;N;$!ba;s/\n//g; s/[A-Z]>/\n>/g; s/[0-9]]/]\n/g' > "trinity/${index}_trinity.Trinity_re.fasta"
done<index_list

sed 's/Trinity.fasta/Trinity_re.fasta/' bowtie2_fasta_input > re_fasta_list


#!/bin/bash

# 讀取 uni_gene 並處理
process_uni_gene() {
    uni_gene_file="$1"
    output_prefix="$2"
    fasta_file="$3"

    echo "正在處理 uni_gene: $uni_gene_file"
	
    # 逐行讀取基因 ID，使用 grep 搜尋 fasta 檔案中的基因名稱並提取符合的結果與下一行
    while IFS= read -r gene; do
       grep -A 1 "$gene" "$fasta_file" >> "trinity/${output_prefix}_extract.fasta"
    done < "$uni_gene_file"

    echo "完成: ${output_prefix}_extract.fasta"
}

# 讀取 rep_gene 並處理
process_rep_gene() {
    rep_gene_file="$1"
    output_prefix="$2"
    fasta_file="$3"

    echo "正在處理 rep_gene: $rep_gene_file"

    while IFS= read -r gene; do
        # 取得第二條件
	        second_condition=$(grep "$gene" "$fasta_file" | cut -d" " -f2 | cut -d"=" -f2 | sort -n | tail -1)
        # 使用 grep 查找符合的基因與第二條件
        grep -A 1 -E "$gene.*$second_condition" "$fasta_file" |grep -v "^--$" >> "trinity/${output_prefix}_extract.fasta"
    done < "$rep_gene_file"

    echo "完成: ${output_prefix}_extract.fasta"
}

export -f process_uni_gene process_rep_gene  # 讓 parallel 可調用函數

# 多核心處理主函數
process_all() {
    # 設定輸入檔案列表
    uni_gene_list="uni_gene"
    rep_gene_list="rep_gene"
    fasta_list="re_fasta_list"
    output_list="index_list"

    # 讀取所有檔案並存入陣列
    mapfile -t uni_gene_files < "$uni_gene_list"
    mapfile -t rep_gene_files < "$rep_gene_list"
    mapfile -t fasta_files < "$fasta_list"
    mapfile -t output_prefixes < "$output_list"

    # 確保四個列表長度一致
    if [[ ${#uni_gene_files[@]} -ne ${#rep_gene_files[@]} ]] || 
       [[ ${#uni_gene_files[@]} -ne ${#fasta_files[@]} ]] || 
       [[ ${#uni_gene_files[@]} -ne ${#output_prefixes[@]} ]]; then
        echo "錯誤: 檔案列表長度不匹配！請檢查輸入檔案。"
        exit 1
    fi
    # 使用 parallel 進行多核心處理
	parallel -j 72 process_uni_gene :::+ "${uni_gene_files[@]}" :::+ "${output_prefixes[@]}" :::+ "${fasta_files[@]}" 
	parallel -j 72 process_rep_gene :::+ "${rep_gene_files[@]}" :::+ "${output_prefixes[@]}" :::+ "${fasta_files[@]}"
    echo "所有檔案處理完畢！"
}

# 執行多核心處理
process_all

#grep ">" K10-K15-F1_22CWMVLT4_extract.fasta| cut -d" " -f1 | sed 's/>K10-K15-F1_22CWMVLT4_//' | sed 's/_i[0-9]\+//'|sort |uniq > K10-K15-F1_22CWMVLT4_check

#cat K10-K15-F1_22CWMVLT4_uni_gene K10-K15-F1_22CWMVLT4_rep_gene |sort |uniq> K10-K15-F1_22CWMVLT4_ori

#diff K10-K15-F1_22CWMVLT4_ori K10-K15-F1_22CWMVLT4_check
----------------------------------------------------cd-hit--------------------------------------------------
mamba install bioconda::cd-hit
#not used
#cat trinity/*_extract.fasta >cd-hit.fasta
#cdhit -i cd-hit.fasta  -o cd-hit -c 1 -M 0 -T 0

cat trinity/*_coding.fasta > coding.fasta
../../trinityrnaseq-v2.15.2/util/misc/get_longest_isoform_seq_per_trinity_gene.pl coding.fasta > cd-hit-est.fasta
cd-hit-est -i cd-hit-est.fasta -o cd-hit-est -c 1 -d 0 -M 0 -T 0

#diamond
----------------------------------------transcript assignment-----------------------------------
cd
wget https://ftp.ncbi.nlm.nih.gov/blast/db/nr-prot-metadata.json
mkdir nr
grep "ftp" nr-prot-metadata.json | sed -e 's/\    "/wget /g' -e 's/",//'>nr/nr_file_list
cd nr
bash nr_file_list
while IFS= read -r file;
do  
	tar -zxf "${file#wget ftp://ftp.ncbi.nlm.nih.gov/blast/db/}"
done<nr_file_list

wget https://ftp.ncbi.nlm.nih.gov/blast/db/FASTA/nr.gz
gunzip nr.gz

diamond makedb --in nr -d nr_db
diamond blastx -d /home/yee/nr_db -q EXPK/analysis/cd-hit-est -o EXPK/analysis/nr_aln --sensitive -p 72 -b 20 -c 1 -e 0.0000000001 --top 5

cd
wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/021/904/315/GCA_021904315.1_S.magellanicum_v1.1/GCA_021904315.1_S.magellanicum_v1.1_genomic.gff.gz
gunzip GCA_021904315.1_S.magellanicum_v1.1_genomic.gff.gz
wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/021/904/315/GCA_021904315.1_S.magellanicum_v1.1/GCA_021904315.1_S.magellanicum_v1.1_genomic.fna.gz
gunzip GCA_021904315.1_S.magellanicum_v1.1_genomic.fna.gz
wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/021/904/315/GCA_021904315.1_S.magellanicum_v1.1/GCA_021904315.1_S.magellanicum_v1.1_protein.faa.gz
gunzip GCA_021904315.1_S.magellanicum_v1.1_protein.faa.gz

diamond makedb --in GCA_021904315.1_S.magellanicum_v1.1_protein.faa  -d S.magellanicum

diamond blastx -d S.magellanicum -q EXPK/analysis/cd-hit-est -o EXPK/analysis/S.magellanicum_aln --sensitive -p 72 -b 50 -c 10 -e 0.000001

wget http://github.com/bbuchfink/diamond/releases/download/v2.1.11/diamond-linux64.tar.gz
tar xzf diamond-linux64.tar.gz

cd EXPK/analysis
awk '$3>=97 {print$0}' S.magellanicum_aln > S.magellanicum_aln_97
awk '$3==100 {print$0}' S.magellanicum_aln > S.magellanicum_aln_100

grep -cFf <(cut -f2 S.magellanicum_aln_97) ../../GCA_021904315.1_S.magellanicum_v1.1_genomic.gff 

awk '$3==100 {print$0}' nr_aln >nr_aln_100
awk '$3>=97 {print$0}' nr_aln >nr_aln_97

-----------------------------------get transcript information-------------------------------
#get taxid,function
cut -f2 nr_aln_97 >nr_aln_97_id
esummary -db protein -input nr_aln_97_id | xtract -pattern DocumentSummary -element Caption, TaxId, Title >nr_aln_97_info

#efetch -db protein -input nr_aln_97_id -format gb > nr_aln_97_id_gbinfo
#grep -E "ACCESSION" nr_aln_97_id_gbinfo | awk -F "   " '{print $2}'>nr_aln_97_info_part1
#grep -E "taxon" nr_aln_97_id_gbinfo | awk -F "[:\"]" '{print $3}' > nr_aln_97_info_part2
#grep -E "DEFINITION" nr_aln_97_id_gbinfo | awk -F "  " '{print $2}' >nr_aln_97_info_part3


grep -P "\t$" nr_taxa_info | cut -f2 | sort | uniq > lack_summary_ID
grep -v "|" <(grep -v "^[0-9]" lack_summary_ID)| cut -d "." -f1 > with_Textseq_ID
grep prf lack_summary_ID | cut -d "|" -f3 >prf_ID
grep pir lack_summary_ID | cut -d "|" -f2 >pir_ID
cat prf_ID pir_ID > with_Textseq-id_name
grep '|' nr_aln_97_id > uniprot_ID
grep "^[0-9]" lack_summary_ID>without_Textseq_ID
awk 'BEGIN{FS=OFS="\t"}
{
cmd = "efetch -db protein -id " $0 " -format fasta | tail -n +2 | tr -d \"\n\"| wc -c";
cmd | getline num
close(cmd) 
printf "%s\t%s\n",$0, num}' without_Textseq_ID > without_Textseq_ID_length

#specify Textseq_ID
awk 'BEGIN{FS=OFS="\t"}
{
cmd = "efetch -db protein -id " $0 " -format gi";
cmd | getline gi
close(cmd) 
printf "%s\t%s\n",$0, gi}' without_Textseq_ID > without_Textseq_ID_gi

	
output=""
cat with_Textseq_ID | parallel --pipe -j 72 '
while IFS= read -r ID; 
do
efetch -db protein -id "$ID" -format xml | xtract -pattern Bioseq-set_seq-set -block Bioseq -if Textseq-id_accession -equals "$ID" -element -first Textseq-id_accession -block BioSource -element -first Object-id_id -block Bioseq -if Textseq-id_accession -equals "$ID" -element -first  Seqdesc_title 
done
echo -e "$output" | awk 'NF'
' > lack_summary_part1

#output=""
#cat with_Textseq-id_name | parallel --pipe -j 72 '
while IFS= read -r ID; 
do
efetch -db protein -id "$ID" -format xml | xtract -pattern Bioseq-set_seq-set -block Bioseq -if Textseq-id_name -equals "$ID" -element -first Textseq-id_name -block BioSource -element -first Object-id_id -block Bioseq -if Textseq-id_name -equals "$ID" -element -first  Seqdesc_title
done
echo -e "$output" | awk 'NF'
' > lack_summary_part2

#uniprot
awk 'BEGIN{FS=OFS="\t"} {print "esearch -db protein -query",$1, "| efetch -format xml | xtract -pattern Bioseq-set_seq-set -block Bioseq -if Textseq-id_name -equals",$1," -element -first Textseq-id_name -block BioSource -element -first Object-id_id -block Bioseq -if Textseq-id_name -equals",$1," -element -first  Seqdesc_title"}' with_Textseq-id_name > with_Textseq-id_name_script
bash with_Textseq-id_name_script > lack_summary_part2

#awk 'BEGIN{FS=OFS="\t"} {print "efetch -db protein -id",$1, "-format xml | xtract -pattern Bioseq-set_seq-set -block Bioseq -if Seq-inst_length -equals",$2,"-element PDB-mol-id Object-id_id Seqdesc_comment"}' without_Textseq_ID_length >without_Textseq_ID_script
#bash without_Textseq_ID_script > lack_summary_part3

#PDB
awk 'BEGIN{FS=OFS="\t"} {print "efetch -db protein -id",$1, "-format xml | xtract -pattern Bioseq-set_seq-set -block Bioseq -if Seq-id_gi -equals",$2,"-element PDB-mol-id Object-id_id Seqdesc_comment"}' without_Textseq_ID_gi > without_Textseq_ID_script
bash without_Textseq_ID_script > lack_summary_part3
cat lack_summary_part1 lack_summary_part2 lack_summary_part3 >> nr_aln_97_info

#while read acc; 
#do efetch -db protein -id "$acc"  -format xml| xtract -pattern Bioseq-set_seq-set -element OrgName_lineage >>tt ;
#done< test_ID

#use taxid to get taxonomy
mamba install -c bioconda taxonkit
wget http://ftp.ncbi.nih.gov/pub/taxonomy/taxdump.tar.gz mv taxdump.tar.gz ../../
tar -zxf ../../taxdump.tar.gz
cut -f2 nr_aln_97_info | sort | uniq >nr_aln_97_taxid
taxonkit --data-dir /home/yee lineage nr_aln_97

#02:06:23.745 [WARN] taxid 1345260 was merged into 3076337
#02:06:23.749 [WARN] taxid 1464779 was merged into 3370059
#02:06:23.761 [WARN] taxid 1898818 was merged into 2849213
#02:06:23.781 [WARN] taxid 286842 was merged into 235900
#02:06:23.785 [WARN] taxid 325530 was merged into 2746698
#02:06:23.787 [WARN] taxid 35662 was merged into 3370056
#02:06:23.787 [WARN] taxid 35664 was merged into 3370057
#02:06:23.787 [WARN] taxid 35665 was merged into 3370058
#02:06:23.789 [WARN] taxid 381198 was merged into 8845

echo -e "3076337\n2849213\n235900\n3397199\n3397198\n2746698\n8845\n4792" >merge_taxid 
taxonkit --data-dir /home/yee lineage merge_taxid > merge_taxon
grep -A1 -Ff <(grep -Ff <(grep -Ff <(grep Sphagnum nr_aln_97_taxon | cut -f1) nr_aln_97_info | cut -f1) nr_aln_97 | cut -f1) cd-hit-est > Sphagnum.fasta
grep -Ff <(grep Sphagnum nr_aln_97_taxon | cut -f1) nr_aln_97_info > Sphagnum_info
grep -A1 -Ff <(grep -Ff <(grep -Ff <(grep Fungi nr_aln_97_taxon | cut -f1) nr_aln_97_info | cut -f1) nr_aln_97 | cut -f1) cd-hit-est > Fungi.fasta
grep -Ff <(grep Fungi nr_aln_97_taxon | cut -f1) nr_aln_97_info > Fungi_info


#efetch -db protein -id KAH9546190  -format xml| xtract -pattern Bioseq-set_seq-set -element OrgName_lineage 
#efetch -db protein -id KAH9546190  -format gb | grep -e "DEFINITION"
#efetch -db protein -id KAH9546190 -format xml | xtract -pattern Seq-id -element Textseq-id_accession

-----------------------------------------combine information-------------------------------------
#cat index_list | sed  's/^/transcript_abundance\//'| sed 's/$/\.isoforms\.results/' > isoforms_results
#../../trinityrnaseq-v2.15.2/util/misc/merge_RSEM_output_to_matrix.pl --rsem_files  isoforms_results --mode counts > transcript_abundance/total_transcripts_counts

#not used
mkdir EXPK_longest
makeblastdb -in cd-hit-est.fasta -dbtype nucl -out EXPK_longest/EXPK_longest
blastn -db EXPK_longest/EXPK_longest -query coding.fasta -out longest_mapping_aln -evalue 1e-10 -outfmt 6 -num_threads 72
awk '$3==100 {print$0}' longest_mapping_aln > longest_mapping_aln_100

#modified from chatgpt,not used
#output=""
#cat cd-hit-est.clstr | parallel --pipe -j 72 '
#while IFS= read -r line; do
#    if [[ "${line:0:1}" != ">" ]]; then
#        index=$(echo "$line" | awk "{print \$1}")
#        if [[ "$index" -eq 0 ]]; then
#            gene=$(echo "$line" | awk -F "[>i]" "{print \$(NF-1)}" | rev | cut -c2- | rev)
#            output+="$gene\t$gene\n"
#        else
#            isoform=$(echo "$line" | awk -F "[>i]" "{print \$(NF-1)}" | rev | cut -c2- | rev)
#            output+="$gene\t$isoform\n"
#        fi
#    fi
#done
#echo -e "$output"
#' > longest_mapping  # Save to a file

#modified from chatgpt,get mapping
#!/bin/bash
# Read the input file line by line, splitting into blocks based on lines starting with '>'
awk '/^>/{if(NR>1)print ""; print $0; next} {print $0}' cd-hit-est.clstr | \
    parallel --pipe --recend '\n\n' -j 72 '  # Process in parallel
    awk -F "[>i]" "
    { 
		isoform = substr(\$2,1,length(\$2) -1)
	        if (substr(\$1,1,1) == 0) {
            gene = isoform  # First line of each block
            print gene \"\t\" isoform
    	    } else if (substr(\$1,1,1) != 0 && substr(\$1,1,1)!= \"\") {
       		     print gene \"\t\" isoform
        }
    }"' > longest_mapping

for file in "${bowtie2_index[@]}"
do
sed -E "s/TRINITY/${file}_TRINITY/g" transcript_abundance/${file}.genes.results >transcript_abundance/${file}.genes.re_results
done

ls transcript_abundance | grep "genes.re_results"| sed 's/^/transcript_abundance\//'> genes.re_result_list

cat transcript_abundance/*genes.re_results| sort | tail -n+24 >transcript_abundance_gene_result
sort -k2 longest_mapping> longest_mapping_sorted
tail -n+2 transcript_abundance_gene_result | sort -k1 > transcript_abundance_gene_result_sorted

awk ' NR==FNR { map[$1] = $2"\t"$3"\t"$4"\t"$5"\t"$6"\t"$7; next} {print $0"\t"map[$2]}' transcript_abundance_gene_result_sorted longest_mapping_sorted > longest_mapping_abundance

#awk ' NR==FNR { map[$1] = $2"\t"$3"\t"$4; next} { isoform= substr($2,1,length($2) -2);
print $0"\t"map[isoform]}' nr_aln_97_info nr_aln_97 > test

#modified from chatgpt,not used
#awk -F $'\t' '
FNR==1 { file_count++ }  # Count how many files are processed

{ 
if (file_count == 1) {
           map1[$1][1] = $2;  # Store data from each file using file_count as an index
			map1 [$1][2] = $3;  # Store data from each file using file_count as an index
			next;
   } else if (file_count == 2) {
map2[$1] = $2;  # Store data from each file using file_count as an index
		next;
   }
    printf "%s\t",$0;  # Print the current line from file1.txt
	isoform = substr($2, 1, length($2) - 2); # Remove last 2 characters from $2
    if (isoform in map1) { 
taxid = map1[isoform][1]; # Get taxid from map1 
printf "%s\t%s\t", map1[isoform][1], map1[isoform][2]; # Print taxid and info 
if (taxid in map2) { # Check if taxid exists in map2 
printf "%s", map2[taxid]; # Print the corresponding taxon data
} 
}
    print "";  # Newline
}'  nr_aln_97_info nr_aln_97_taxon nr_aln_97 > nr_taxa_info

grep -vFf lack_summary_ID nr_aln_97 >nr_aln_97_part0
grep -Ff with_Textseq_ID nr_aln_97 > nr_aln_97_part1
grep -Ff uniprot_ID nr_aln_97 > nr_aln_97_part2
grep -Ff without_Textseq_ID nr_aln_97 > nr_aln_97_part3
cat nr_aln_97_part0 >> nr_aln_97_part1

#modified from chatgpt
awk -F $'\t' '
FNR==1 { file_count++ }  # Count how many files are processed

{ 
if (file_count == 1) {
           map1[$1][1] = $2;  # Store data from each file using file_count as an index
map1[$1][2] = $3;  # Store data from each file using file_count as an index
next;
   } else if (file_count == 2) {
map2[$1] = $2;  # Store data from each file using file_count as an index
next;
   }
    printf "%s\t",$0;  # Print the current line from file1.txt
	isoform = substr($2, 1, length($2) - 2); # Remove last 2 characters from $2
    if (isoform in map1) { 
taxid = map1[isoform][1]; # Get taxid from map1 
printf "%s\t%s\t", map1[isoform][1], map1[isoform][2]; # Print taxid and info 
if (taxid in map2) { # Check if taxid exists in map2 
printf "%s", map2[taxid]; # Print the corresponding taxon data
} 
}
    print "";  # Newline
}'  nr_aln_97_info nr_aln_97_taxon nr_aln_97_part1 > nr_taxa_info_part1

awk -F $'\t' '
FNR==1 { file_count++ }  # Count how many files are processed

{ 
if (file_count == 1) {
           map1[$1][1] = $2;  # Store data from each file using file_count as an index
map1[$1][2] = $3;  # Store data from each file using file_count as an index
next;
   } else if (file_count == 2) {
map2[$1] = $2;  # Store data from each file using file_count as an index
next;
   }
    printf "%s\t",$0;  # Print the current line from file1.txt
	type = substr($2, 1, 3)
if(type == "pir"){
isoform = substr($2, 5, length($2) - 5);
}else if(type == "prf"){
	isoform = substr($2, 6);
}
    if (isoform in map1) { 
taxid = map1[isoform][1]; # Get taxid from map1 
printf "%s\t%s\t", map1[isoform][1], map1[isoform][2]; # Print taxid and info 
if (taxid in map2) { # Check if taxid exists in map2 
printf "%s", map2[taxid]; # Print the corresponding taxon data
} 
}
    print "";  # Newline
}'  nr_aln_97_info nr_aln_97_taxon nr_aln_97_part2 > nr_taxa_info_part2

awk -F $'\t' '
FNR==1 { file_count++ }  # Count how many files are processed

{ 
if (file_count == 1) {
           map1[$1][1] = $2;  # Store data from each file using file_count as an index
map1[$1][2] = $3;  # Store data from each file using file_count as an index
next;
   } else if (file_count == 2) {
map2[$1] = $2;  # Store data from each file using file_count as an index
next;
   }
    printf "%s\t",$0;  # Print the current line from file1.txt
	split($2,id, "_")
	isoform = id[1];
    if (isoform in map1) { 
taxid = map1[isoform][1]; # Get taxid from map1 
printf "%s\t%s\t", map1[isoform][1], map1[isoform][2]; # Print taxid and info 
if (taxid in map2) { # Check if taxid exists in map2 
printf "%s", map2[taxid]; # Print the corresponding taxon data
} 
}
    print "";  # Newline
}'  nr_aln_97_info nr_aln_97_taxon nr_aln_97_part3 > nr_taxa_info_part3

cat nr_taxa_info_part1 nr_taxa_info_part2 nr_taxa_info_part3 > nr_taxa_info
---------------------------------------------------Trinotate---------------------------------------------
cd ..
mamba install bioconda::hmmer
mamba install bioconda::diamond
mamba install bioconda::eggnog-mapper
mkdir ../../eggnog_data
download_eggnog_data.py --data_dir ../../eggnog_data -y -H -M -f
export EGGNOG_DATA_DIR=/home/yee/eggnog_data

#../../Trinotate-Trinotate-v4.0.2/Trinotate --create --db EXPK_uni.sqlite --trinotate_data_dir /home/yee/Trinotate --use_diamond

#../../Trinotate-Trinotate-v4.0.2/Trinotate --db EXPK_uni.sqlite --init --transcript_fasta cd-hit-est --transdecoder_pep transdecoder/cd-hit-est.transdecoder.pep

#../../Trinotate-Trinotate-v4.0.2/Trinotate --db EXPK_uni.sqlite --CPU 72 --transcript_fasta cd-hit-est --transdecoder_pep transdecoder/cd-hit-est.transdecoder.pep --trinotate_data_dir /home/yee/Trinotate --run "swissprot_blastp swissprot_blastx pfam EggnogMapper" --use_diamond 

#../../Trinotate-Trinotate-v4.0.2/Trinotate --db EXPK_uni.sqlite --report > Trinotate_report_uni.tsv


../../Trinotate-Trinotate-v4.0.2/Trinotate --create --db EXPK_longest.sqlite --trinotate_data_dir /home/yee/Trinotate --use_diamond

awk '/^>/{if(NR>1)print ""; print $0; next} {print $0}' cd-hit-est.clstr | \
    parallel --pipe --recend '\n\n' -j 72 '  # Process in parallel
    awk -F "[>.]" "
    { 
isoform = substr(\$2,1,length(\$2) )
if (substr(\$1,1,1) == 0) {
gene = isoform  # First line of each block
print gene \"\t\" isoform
    	} else if (substr(\$1,1,1) != 0 && substr(\$1,1,1)!= \"\") {
print gene \"\t\" isoform
}
    }"' > longest_mapping.gene_trans_map

../../Trinotate-Trinotate-v4.0.2/Trinotate --db EXPK_longest.sqlite --init --transcript_fasta cd-hit-est.fasta --gene_trans_map longest_mapping.gene_trans_map --transdecoder_pep transdecoder/cd-hit-est.fasta.transdecoder.pep

../../Trinotate-Trinotate-v4.0.2/Trinotate --db EXPK_longest.sqlite --CPU 72 --transcript_fasta cd-hit-est.fasta --transdecoder_pep transdecoder/cd-hit-est.fasta.transdecoder.pep --trinotate_data_dir /home/yee/Trinotate --run "swissprot_blastp swissprot_blastx pfam EggnogMapper" --use_diamond 

../../Trinotate-Trinotate-v4.0.2/Trinotate --db EXPK_longest.sqlite --report > Trinotate_report_longest.tsv

cat trinity/*_re.fasta > all_transcripts.fasta
pip3 install pybiolib
pip install docker
cd 
curl -fsSL https://get.docker.com/rootless | sh
systemctl --user start docker.service
export PATH=/home/yee/bin:$PATH
export DOCKER_HOST=unix:///run/user/1004/docker.sock
cd /home/yee/EXPK/analysis
biolib run --local 'DTU/DeepTMHMM:1.0.24' --fasta cd-hit-est
cd
tar -zxf signalp-6.0h.slow_sequential.tar.gz
cd signalp6_slow_sequential/
SIGNALP_DIR=$(python3 -c "import signalp; import os; print(os.path.dirname(signalp.__file__))" )
cp -r signalp-6-package/models/* $SIGNALP_DIR/model_weights/
cd /home/yee/EXPK/analysis/
signalp6 --fastafile cd-hit-est --output_dir signalp6 --mode slow-sequential --torch_num_threads 72

------------------estimate cd—hit-est abundance---------------
mkdir longest

while IFS= read -r line;
do 
../../trinityrnaseq-v2.15.2/util/align_and_estimate_abundance.pl --thread_count 72 --seqType fq --left ../ExpKRNA/paired/"$line"_R1_paired.fastq.gz --right ../ExpKRNA/paired/"$line"_R2_paired.fastq.gz --transcripts cd-hit-est --est_method RSEM --aln_method bowtie  --trinity_mode --prep_reference --output_dir ./longest --output_prefix "$line"; 
done<index_list

../../trinityrnaseq-v2.15.2/util/abundance_estimates_to_matrix.pl --est_method RSEM --gene_trans_map none --quant_files longest_genes.results_list

#grep -A1 --no-group-separator "K10-K9" cd-hit-est >test

-----------------------------------------------------DEseq2-------------------------------------------------
ls longest | grep "genes.results"| sed 's/^/longest\//'> longest_genes.results_list

../../trinityrnaseq-v2.15.2/util/misc/merge_RSEM_output_to_matrix.pl --rsem_files longest_genes.results_list --mode counts>longest_count_matrix

#R
install.packages("DESeq2")
library(DESeq2)
library(readr)
BiocManager::install("tximport")

sed -ie 's/F\([12]\)/F\1_22CWMVLT4/g' ExpK_experiment_design.tsv
sed -ie 's/-/_/g' ExpK_experiment_design.tsv
cut -f1,2 ExpK_experiment_design.tsv | awk '{print $2"\t"$1}'| tail -n+2 > pass_hold
cut -f1,3 ExpK_experiment_design.tsv | awk '{print $2"\t"$1}'| tail -n+2 > CueifongLake_Tsaopi
cut -f1,4 ExpK_experiment_design.tsv | awk '{print $2"\t"$1}'| tail -n+2 > HIGH_LOW

mkdir DESeq2
mkdir DESeq2/pass_hold
mkdir DESeq2/CueifongLake_Tsaopi
mkdir DESeq2/HIGH_LOW  
mkdir DESeq2/fungi
mkdir DESeq2/fungi/pass_hold DESeq2/fungi/CueifongLake_Tsaopi DESeq2/fungi/HIGH_LOW
mkdir DESeq2/sphagnum
mkdir DESeq2/sphagnum/pass_hold DESeq2/sphagnum/CueifongLake_Tsaopi DESeq2/sphagnum/HIGH_LOW

../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix longest_count_matrix.matrix --method DESeq2 --samples_file pass_hold --output DESeq2/pass_hold
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix longest_count_matrix --method DESeq2 --samples_file CueifongLake_Tsaopi --output DESeq2/CueifongLake_Tsaopi
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix longest_count_matrix --method DESeq2 --samples_file HIGH_LOW --output DESeq2/HIGH_LOW

../../Trinotate-Trinotate-v4.0.2/util/extract_GO_assignments_from_Trinotate_xls.pl --Trinotate_xls Trinotate_report_longest.tsv --gene --include_ancestral_terms > go_annotations.txt

cd DESeq2/pass_hold
../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix longest_count_matrix.Hold_vs_Pass.DESeq2.count_matrix  -P 1e-3 -C 2

cd ../CueifongLake_Tsaopi
../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix longest_count_matrix.CueifongLake_vs_Tsaopi.DESeq2.count_matrix  -P 1e-3 -C 2

cd ../HIGH_LOW
../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix longest_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix  -P 1e-3 -C 2

grep 'Sphagnum' nr_taxa_info | cut -f1,2,14,15 >Sphagnum_info
grep -A1 -Ff <(grep 'Sphagnum' nr_taxa_info | cut -f1) cd-hit-est > Sphagnum.fasta
grep 'Fungi' nr_taxa_info | cut -f1,2,14,15 >Fungi_info
grep -A1 -Ff <(grep 'Fungi' nr_taxa_info | cut -f1) cd-hit-est > Fungi.fasta

grep ">" Fungi.fasta | awk -F "[>i]" "{print \$(NF-1)}" | rev | cut -c2- | rev > Fungi_gene
grep ">" Sphagnum.fasta | awk -F "[>i]" "{print \$(NF-1)}" | rev | cut -c2- | rev > Sphagnum_gene
cat longest_count_matrix | head -n1 > Fungi_count_matrix 
grep -Ff Fungi_gene longest_count_matrix >> Fungi_count_matrix
cat longest_count_matrix | head -n1 > Sphagnum_count_matrix 
grep -Ff Sphagnum_gene longest_count_matrix >> Sphagnum_count_matrix

../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix Fungi_count_matrix --method DESeq2 --samples_file pass_hold --output DESeq2/fungi/pass_hold
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix Fungi_count_matrix --method DESeq2 --samples_file CueifongLake_Tsaopi --output DESeq2/fungi/CueifongLake_Tsaopi
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix Fungi_count_matrix --method DESeq2 --samples_file HIGH_LOW --output DESeq2/fungi/HIGH_LOW

../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix Sphagnum_count_matrix --method DESeq2 --samples_file pass_hold --output DESeq2/sphagnum/pass_hold
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix Sphagnum_count_matrix --method DESeq2 --samples_file CueifongLake_Tsaopi --output DESeq2/sphagnum/CueifongLake_Tsaopi
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix Sphagnum_count_matrix --method DESeq2 --samples_file HIGH_LOW --output DESeq2/sphagnum/HIGH_LOW

cd DESeq2/fungi/pass_hold
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix Fungi_count_matrix.Hold_vs_Pass.DESeq2.count_matrix  -P 1e-3 -C 2
cd ../CueifongLake_Tsaopi
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix Fungi_count_matrix.CueifongLake_vs_Tsaopi.DESeq2.count_matrix -P 1e-3 -C 2
cd ../HIGH_LOW
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix Fungi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix  -P 1e-3 -C 2
cd ../../sphagnum/pass_hold
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix Sphagnum_count_matrix.Hold_vs_Pass.DESeq2.count_matrix  -P 1e-3 -C 2
cd ../CueifongLake_Tsaopi
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix Sphagnum_count_matrix.CueifongLake_vs_Tsaopi.DESeq2.count_matrix -P 1e-3 -C 2
cd ../HIGH_LOW
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix Sphagnum_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix  -P 1e-3 -C 2

#../../trinityrnaseq-v2.15.2/util/abundance_estimates_to_matrix.pl --est_method RSEM --gene_trans_map none --quant_files longest_genes.results_list

#../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix RSEM.isoform.TMM.EXPR.matrix --method DESeq2 --samples_file pass_hold --output DESeq2/pass_hold

#####not use
awk '($3+0)<= 1e-10 && $9 >= 97 {print $0}' eggnog_mapper.emapper.seed_orthologs | grep -P "^K" | cut -f1 | rev | cut -c4- | rev > Trinotate_qualified_ID
cut -f1 Fungi_info > Fungi_gene_ID
cut -f1 Sphagnum_info > Sphagnum_gene_ID
grep 'Fungi' Trinotate_report_longest.tsv | cut -f1 > Fungi_Trinotate_ID
grep 'Sphagnum' Trinotate_report_longest.tsv | cut -f1 > Sphagnum_ID_Trinotate_ID

grep -Ff Sphagnum_gene_ID Sphagnum_ID_Trinotate_ID > Sphagnum_ID_Trinotate_ID_check
grep -Ff Sphagnum_ID_Trinotate_ID_check Trinotate_report_longest.tsv | grep -v 'Sphagnum' | cut -f1 | sort | uniq > Sphagnum_ID_Trinotate_ID_check_multi
grep -vFf Sphagnum_gene_ID Sphagnum_ID_Trinotate_ID> Sphagnum_lowQ
grep -vFf Sphagnum_ID_Trinotate_ID Sphagnum_gene_ID | sort | uniq > Sphagnum_onlynr 
grep -Ff Sphagnum_onlynr nr_taxa_info | grep -v 'Sphagnum'| cut -f1 | sort | uniq > Sphagnum_onlynr_multi
grep -vFf Sphagnum_onlynr_multi Sphagnum_onlynr | sort | uniq > Sphagnum_onlynr_only

grep -Ff Fungi_gene Fungi_Trinotate_ID > Fungi_Trinotate_ID_check
grep -Ff Fungi_Trinotate_ID_check Trinotate_report_longest.tsv | grep -v 'Fungi' | cut -f1 | sort | uniq > Fungi_Trinotate_ID_check_multi
grep -Ff Fungi_Trinotate_ID_check nr_taxa_info| grep -v 'Fungi' | cut -f1 | sort | uniq >> Fungi_Trinotate_ID_check_multi
sort Fungi_Trinotate_ID_check_multi | uniq > tmp
mv tmp Fungi_Trinotate_ID_check_multi
grep -vFf Fungi_Trinotate_ID_check_multi Fungi_Trinotate_ID_check | sort | uniq > Fungi_Trinotate_ID_check_only
grep -vFf Fungi_gene_ID Fungi_Trinotate_ID> Fungi_lowQ

grep -vFf Fungi_Trinotate_ID Fungi_gene_ID | sort | uniq > Fungi_onlynr 
grep -Ff Fungi_onlynr nr_taxa_info | grep -v 'Fungi'| cut -f1 | sort | uniq > Fungi_onlynr_multi
grep -vFf Fungi_onlynr_multi Fungi_onlynr | sort | uniq > Fungi_onlynr_only

cat Fungi_gene_ID Fungi_Trinotate_ID | sort | uniq > Fungi_ID_all
cat Sphagnum_gene_ID Sphagnum_Trinotate_ID | sort | uniq > Sphagnum_ID_all

######

grep 'Embryophyta' nr_taxa_info >plant_info
cut -f1 plant_info > plant_gene_ID
grep 'Embryophyta' Trinotate_report_longest.tsv | cut -f1 > plant_Trinotate_ID
grep 'Fungi' nr_taxa_info > Fungi_info
cut -f1 Fungi_info > Fungi_gene_ID
grep ' Fungi' Trinotate_report_longest.tsv | cut -f1 > Fungi_Trinotate_ID
grep -A1 -Ff plant_gene_ID cd-hit-est > plant.fasta
grep -A1 -Ff Fungi_gene_ID cd-hit-est > Fungi.fasta
cat Fungi_gene_ID Fungi_Trinotate_ID | sort | uniq > Fungi_ID_all
cat plant_gene_ID plant_Trinotate_ID | sort | uniq > plant_ID_all
cut -d 'i' -f1 Fungi_ID_all | rev | cut -c2- | rev > Fungi_gene
cut -d 'i' -f1 plant_ID_all | rev | cut -c2- | rev > plant_gene

cat longest_count_matrix | head -n1 > Fungi_count_matrix 
grep -Ff Fungi_gene longest_count_matrix >> Fungi_count_matrix
cat longest_count_matrix | head -n1 > plant_count_matrix 
grep -Ff plant_gene longest_count_matrix >> plant_count_matrix

mkdir plant
mkdir plant/CueifongLake plant/Tsaopi
rm -r fungi
mkdir fungi
mkdir fungi/CueifongLake fungi/Tsaopi

grep -P '\t1|\t2|\t3|\t4' ExpK_experiment_design.tsv | awk '{print $4"\t"$1}'> CueifongLake
grep -P '\t5|\t6|\t7' ExpK_experiment_design.tsv | awk '{print $4"\t"$1}'> Tsaopi
awk '{ORS=","} NR==FNR{a[$0]; next} {for(i=1;i<=NF;i++) if($i in a) print FNR}' <(cut -f2 CueifongLake) <(head -n1 Fungi_count_matrix | tr '\t' '\n')
awk '{ORS=","} NR==FNR{a[$0]; next} {for(i=1;i<=NF;i++) if($i in a) print FNR}' <(cut -f2 Tsaopi) <(head -n1 Fungi_count_matrix | tr '\t' '\n')
cut -f 1,2,3,5,11,12,13,14,15,16,17,18,21 Fungi_count_matrix >Fungi_CueifongLake_count_matrix
cut -f 1,4,6,7,8,9,10,19,20,22,23,24,25 Fungi_count_matrix > Fungi_Tsaopi_count_matrix
cut -f 1,2,3,5,11,12,13,14,15,16,17,18,21 plant_count_matrix >plant_CueifongLake_count_matrix
cut -f 1,4,6,7,8,9,10,19,20,22,23,24,25 plant_count_matrix > plant_Tsaopi_count_matrix

../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix Fungi_CueifongLake_count_matrix --method DESeq2 --samples_file CueifongLake --output DESeq2/fungi/CueifongLake
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix Fungi_Tsaopi_count_matrix --method DESeq2 --samples_file Tsaopi --output DESeq2/fungi/Tsaopi
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix plant_CueifongLake_count_matrix --method DESeq2 --samples_file CueifongLake --output DESeq2/plant/CueifongLake
../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix plant_Tsaopi_count_matrix --method DESeq2 --samples_file Tsaopi --output DESeq2/plant/Tsaopi

cd DESeq2/fungi/CueifongLake
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix  -P 1e-3 -C 2 --examine_GO_enrichment --GO_annots ../../../go_annotations.txt --gene_lengths ../../../seq_length

cd ../Tsaopi/
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix  -P 1e-3 -C 2 --examine_GO_enrichment --GO_annots ../../../go_annotations.txt --gene_lengths ../../../seq_length

cd ../../plant/CueifongLake/
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix  -P 1e-3 -C 2 --examine_GO_enrichment --GO_annots ../../../go_annotations.txt --gene_lengths ../../../seq_length

cd ../Tsaopi/
../../../../../trinityrnaseq-v2.15.2/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix  -P 1e-3 -C 2 --examine_GO_enrichment --GO_annots ../../../go_annotations.txt --gene_lengths ../../../seq_length

#no information GO ID in GO.db
grep "none" DESeq2/plant/Tsaopi/*.GOseq.depleted | awk -F "[\t:]" '{print $3}' | sed 's/^/GO:/' >go_replace.txt
grep "none" DESeq2/plant/Tsaopi/*.GOseq.enriched | awk -F "[\t:]" '{print $3}' | sed 's/^/GO:/' >>go_replace.txt
grep "none" DESeq2/plant/CueifongLake/*.GOseq.depleted | awk -F "[\t:]" '{print $3}' | sed 's/^/GO:/' >>go_replace.txt
grep "none" DESeq2/plant/CueifongLake/*.GOseq.enriched | awk -F "[\t:]" '{print $3}' | sed 's/^/GO:/' >>go_replace.txt
grep "none" DESeq2/fungi/Tsaopi/*.GOseq.depleted | awk -F "[\t:]" '{print $3}' | sed 's/^/GO:/' >>go_replace.txt
grep "none" DESeq2/fungi/Tsaopi/*.GOseq.enriched | awk -F "[\t:]" '{print $3}' | sed 's/^/GO:/' >>go_replace.txt
grep "none" DESeq2/fungi/CueifongLake/*.GOseq.depleted | awk -F "[\t:]" '{print $3}' | sed 's/^/GO:/' >>go_replace.txt
grep "none" DESeq2/fungi/CueifongLake/*.GOseq.enriched | awk -F "[\t:]" '{print $3}' | sed 's/^/GO:/' >>go_replace.txt
cat go_replace.txt | sort | uniq > tmp
mv tmp  go_replace.txt

#!/bin/bash

INPUT="go_replace.txt"
OUTPUT="go_term_checked"

while read -r go_id; do
    # 查詢 API
    response=$(curl -s -H "Accept: application/json" \
        "https://www.ebi.ac.uk/QuickGO/services/ontology/go/terms/${go_id}/complete")

    # 檢查是否成功回傳資料
    if echo "$response" | jq -e '.results[0]' > /dev/null 2>&1; then
replacement=$(echo "$response" | jq -r '.results[0].replacements[0].id')
id=$(echo "$response" | jq -r '.results[0].id')
if [ "$id" == "$go_id" ]; then
echo -e "${go_id}\t${replacement}" >> "$OUTPUT"
else
echo -e "${go_id}\t${id}" >> "$OUTPUT"
fi
    else
        echo -e "${go_id}\tN/A" >> "$OUTPUT"
    fi
done < "$INPUT"

grep -v "null" go_term_checked > go_replace_rule
while IFS=$'\t' read -r target replace;
do 
	sed -i "s/${target}/${replace}/g" go_annotations.txt;
	sed -i "s/,${replace}//2" go_annotations.txt;
done< go_replace_rule

cd ../../../
cut -f1 DESeq2/fungi/CueifongLake/Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset | tail  -n+2 > Fungi_HIGH_gene
cut -f1 DESeq2/fungi/Tsaopi/Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset | tail  -n+2 >> Fungi_HIGH_gene
sort Fungi_HIGH_gene | uniq > tmp
mv tmp Fungi_HIGH_gene

cut -f1 DESeq2/fungi/CueifongLake/Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset | tail  -n+2 > Fungi_LOW_gene
cut -f1 DESeq2/fungi/Tsaopi/Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset | tail  -n+2 >> Fungi_LOW_gene
sort Fungi_LOW_gene | uniq >tmp
mv tmp Fungi_LOW_gene

cut -f1 DESeq2/plant/CueifongLake/plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset | tail  -n+2 > plant_HIGH_gene
cut -f1 DESeq2/plant/Tsaopi/plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset | tail  -n+2 >> plant_HIGH_gene
sort plant_HIGH_gene | uniq > tmp
mv tmp plant_HIGH_gene

cut -f1 DESeq2/plant/CueifongLake/plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset | tail  -n+2 > plant_LOW_gene
cut -f1 DESeq2/plant/Tsaopi/plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset | tail  -n+2 >> plant_LOW_gene
sort plant_LOW_gene | uniq >tmp
mv tmp plant_LOW_gene

cat <(tail -n+2 DESeq2/fungi/CueifongLake/Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset ) <(tail -n+2 DESeq2/fungi/Tsaopi/Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset) | cut -f1  | sort | uniq -d > Fungi_HIGH_gene_common

cat <(tail -n+2 DESeq2/fungi/CueifongLake/Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset ) <(tail -n+2 DESeq2/fungi/Tsaopi/Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset) | cut -f1  | sort | uniq -d > Fungi_LOW_gene_common

cat <(tail -n+2 DESeq2/plant/CueifongLake/plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset ) <(tail -n+2 DESeq2/plant/Tsaopi/plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset) | cut -f1  | sort | uniq -d > plant_HIGH_gene_common

cat <(tail -n+2 DESeq2/plant/CueifongLake/plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset ) <(tail -n+2 DESeq2/plant/Tsaopi/plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset) | cut -f1  | sort | uniq -d > plant_LOW_gene_common

#common
#Fungi_HIGH: hypothetical protein(lack),q(Tr)
#Fungi_LOW: hypothetical protein, ubiquitin, uncharacterized protein (nr),…(Tr), hypothetical protein, ubiquitin, uncharacterized protein(lack)
#plant_HIGH: hypothetical protein(nr),reqtrovirus transposon, enolase…(Tr), solute transporter(Tr) …, hypothetical protein(lack)
#plant_LOW: ubiquitin(nr),…(Tr), hypothetical protein, ubiquitin, uncharacterized protein, ribosomal protein,tubulin(lack)
#Fungi_CueifongLake_HIGH:12
#Fungi_CueifongLake_LOW:495
#Fungi_Tsaopi_HIGH:9
#Fungi_Tsaopi_LOW:364
#plant_CueifongLake_HIGH:577
#plant_CueifongLake_LOW:1510
#plant_Tsaopi_HIGH:220
#plant_Tsaopi_LOW:232

#Fungi_Tsaopi:30363 
#Fungi_CueifongLake:38933 
#plant_CueifongLake:185840 
#plant_Tsaopi:184462

grep -vFf <(grep -Ff Fungi_HIGH_gene nr_taxa_info | cut -f1 | sort | uniq | cut -d 'i' -f1 | rev | cut -c2- | rev) Fungi_HIGH_gene > Fungi_HIGH_DEG_lack_nr_info
grep -vFf <(grep -Ff Fungi_LOW_gene nr_taxa_info | cut -f1 | sort | uniq | cut -d 'i' -f1 | rev | cut -c2- | rev) Fungi_LOW_gene > Fungi_LOW_DEG_lack_nr_info
grep -vFf <(grep -Ff plant_HIGH_gene nr_taxa_info | cut -f1 | sort | uniq | cut -d 'i' -f1 | rev | cut -c2- | rev) plant_HIGH_gene > plant_HIGH_DEG_lack_nr_info
grep -vFf <(grep -Ff plant_LOW_gene nr_taxa_info | cut -f1 | sort | uniq | cut -d 'i' -f1 | rev | cut -c2- | rev) plant_LOW_gene > plant_LOW_DEG_lack_nr_info

grep -Ff <(cat Fungi_HIGH_DEG_lack_nr_info Fungi_LOW_DEG_lack_nr_info plant_HIGH_DEG_lack_nr_info plant_LOW_DEG_lack_nr_info) nr_aln | cut -f2 | sort | uniq > DEG_lack_info_id

grep '\.' DEG_lack_info_id > DEG_lack_info_id_part1
grep '|' DEG_lack_info_id | awk -F "[|]" '{if(substr($1,1,3)=="pir"){print $2} else if(substr($1,1,3)=="prf"){print $3}}'>DEG_lack_info_id_part2
grep "^[0-9]" DEG_lack_info_id > DEG_lack_info_id_part3

esummary -db protein -input DEG_lack_info_id_part1 | xtract -pattern DocumentSummary -element Caption, TaxId, Title > DEG_lack_info

grep -vFf <(cut -f1 DEG_lack_info) DEG_lack_info_id_part1 | cut -d "." -f1 >DEG_lack_info_id_lack_summary

while IFS= read -r ID;  do efetch -db protein -id "$ID" -format xml | xtract -pattern Bioseq-set_seq-set -block Bioseq -if Textseq-id_accession -equals "$ID" -element -first Textseq-id_accession -block BioSource -element -first Object-id_id -block Bioseq -if Textseq-id_accession -equals "$ID" -element -first  Seqdesc_title  >> DEG_lack_info_part1; done<DEG_lack_info_id_lack_summary

awk 'BEGIN{FS=OFS="\t"} {print "esearch -db protein -query",$1, "| efetch -format xml | xtract -pattern Bioseq-set_seq-set -block Bioseq -if Textseq-id_name -equals",$1," -element -first Textseq-id_name -block BioSource -element -first Object-id_id -block Bioseq -if Textseq-id_name -equals",$1," -element -first  Seqdesc_title"}' DEG_lack_info_id_part2 > DEG_lack_info_id_part2_script
bash DEG_lack_info_id_part2_script > DEG_lack_info_part2

awk 'BEGIN{FS=OFS="\t"}
{
cmd = "efetch -db protein -id " $0 " -format gi";
cmd | getline gi
close(cmd) 
printf "%s\t%s\n",$0, gi}' DEG_lack_info_id_part3 > DEG_lack_info_id_part3_gi

awk 'BEGIN{FS=OFS="\t"} {print "efetch -db protein -id",$1, "-format xml | xtract -pattern Bioseq-set_seq-set -block Bioseq -if Seq-id_gi -equals",$2,"-element PDB-mol-id Object-id_id Seqdesc_comment"}' DEG_lack_info_id_part3_gi > DEG_lack_info_part3_script
bash DEG_lack_info_part3_script > DEG_lack_info_part3

cat DEG_lack_info_part1 DEG_lack_info_part2 DEG_lack_info_part3 >> DEG_lack_info

cut -f2 DEG_lack_info | sort | uniq >  DEG_lack_info_taxid
taxonkit --data-dir /home/yee lineage DEG_lack_info_taxid > DEG_lack_info_taxon

03:05:49.028 [WARN] taxid 3402493 not found
03:05:49.028 [WARN] taxid 3416354 not found

#3402493
#cellular organisms; Eukaryota; Opisthokonta; Metazoa; Eumetazoa; Bilateria; Protostomia; Ecdysozoa; Panarthropoda; Arthropoda; Mandibulata; Pancrustacea; Hexapoda; Insecta; Dicondylia; Pterygota; Neoptera; Endopterygota; Coleoptera; Polyphaga; Cucujiformia; Chrysomeloidea; Chrysomelidae; Galerucinae; Alticini; Psylliodes

#3416354
#cellular organisms; Bacteria; Pseudomonadati; FCB group; Bacteroidota/Chlorobiota group; Bacteroidota; Bacteroidia; Candidatus Pollutiaquabacterales; Candidatus Pollutiaquabacteraceae; Candidatus Pollutiaquabacter; unclassified Candidatus Pollutiaquabacter
sed -ie "s/3402493\t/3402493\tcellular organisms;Eukaryota;Opisthokonta;Metazoa;Eumetazoa;Bilateria; Protostomia;Ecdysozoa;Panarthropoda;Arthropoda;Mandibulata;Pancrustacea;Hexapoda;Insecta;Dicondylia;Pterygota;Neoptera;Endopterygota;Coleoptera;Polyphaga;Cucujiformia;Chrysomeloidea;Chrysomelidae;Galerucinae;Alticini;Psylliodes/" DEG_lack_info_taxon

sed -ie "s/3416354\t/3416354\tcellular organisms;Bacteria;Pseudomonadati;FCB group;Bacteroidota\/Chlorobiota group;Bacteroidota;Bacteroidia;Candidatus Pollutiaquabacterales;Candidatus Pollutiaquabacteraceae;Candidatus Pollutiaquabacter;unclassified Candidatus Pollutiaquabacter/" DEG_lack_info_taxon

grep -Ff DEG_lack_info_id nr_aln > DEG_lack_info_aln

awk -F $'\t' '
FNR==1 { file_count++ }  # Count how many files are processed

{ 
if (file_count == 1) {
           map1[$1][1] = $2;  # Store data from each file using file_count as an index
map1[$1][2] = $3;  # Store data from each file using file_count as an index
next;
   } else if (file_count == 2) {
map2[$1] = $2;  # Store data from each file using file_count as an index
next;
   }
    printf "%s\t",$0;  # Print the current line from file1.txt
	isoform = substr($2, 1, length($2) - 2); # Remove last 2 characters from $2
    if (isoform in map1) { 
taxid = map1[isoform][1]; # Get taxid from map1 
printf "%s\t%s\t", map1[isoform][1], map1[isoform][2]; # Print taxid and info 
if (taxid in map2) { # Check if taxid exists in map2 
printf "%s", map2[taxid]; # Print the corresponding taxon data
} 
}
    print "";  # Newline
}' DEG_lack_info DEG_lack_info_taxon DEG_lack_info_aln > DEG_lack_taxa_info

-----------------------------------------------KEGGseq---------------------------------------------------
cut -f1,26 Trinotate_report_longest.tsv | tail -n+2 | sed -e 's/_i[0-9]*\t/\t/' -e 's/ko://g' | grep -vP "\t.$"| awk '
{
    split($2, KOID, /[,]/)              
    for (i in KOID) {
        if (KOID[i] != "") {
            key = $1
            val = KOID[i]
            if (!(val in seen[key])) {
                seen[key][val] = 1
                KEGG[key] = KEGG[key] ? KEGG[key] "," val : val
            }                                                  
        }                                                      
    }        
}        
END {
    for (k in KEGG){
        print k "\t" KEGG[k]
    }                       
}                    
'> KEGG_annotations.txt

#modified from trinity run_Goseq.pl
cd DESeq2/plant/Tsaopi
perl ../../../run_KEGGseq.pl --genes_single_factor plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.DE.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_KEGGseq.pl --genes_single_factor plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_KEGGseq.pl --genes_single_factor plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

cd ../CueifongLake
perl ../../../run_KEGGseq.pl --genes_single_factor plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.DE.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_KEGGseq.pl --genes_single_factor plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_KEGGseq.pl --genes_single_factor plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

cd ../../fungi/CueifongLake
perl ../../../run_KEGGseq.pl --genes_single_factor Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.DE.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_KEGGseq.pl --genes_single_factor Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_KEGGseq.pl --genes_single_factor Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

cd ../Tsaopi
perl ../../../run_KEGGseq.pl --genes_single_factor Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.DE.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_KEGGseq.pl --genes_single_factor Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_KEGGseq.pl --genes_single_factor Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset --KEGG_assignments ../../../KEGG_annotations.txt --lengths ../../../seq_length --background Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

cd ../../../
---------------------------------------------pathwayseq-----------------------------------------------
#cut -f1,27 Trinotate_report_longest.tsv | tail -n+2 | sed 's/_i[0-9]*\t/\t/'| grep -vP "\t.$"| awk -F',' '{half=NF/2; for (i=1;i<=half;i++){printf "%s",$i; if(i < half){printf ","}} printf "\n"}' > pathway_annotations.txt

cut -f1,27 Trinotate_report_longest.tsv | tail -n+2 | sed -e 's/_i[0-9]*\t/\t/' -e 's/ko/map/g'| grep -vP "\t.$"| awk '
{
    split($2, mapid, /[,]/)              
    for (i in mapid) {
        if (mapid[i] != "") {
            key = $1
            val = mapid[i]
            if (!(val in seen[key])) {
                seen[key][val] = 1
                pathway[key] = pathway[key] ? pathway[key] "," val : val
            }                                                  
        }                                                      
    }        
}        
END {
    for (k in pathway){
        print k "\t" pathway[k]
    }                       
}                    
' > pathway_annotations.txt

#map01130 Deleted; merged into 01110
sed -ie 's/map01130/map01110/g' pathway_annotations.txt 
sed -ie 's/,map01110//2' pathway_annotations.txt

#map00472 Deleted; merged into 00470
sed -ie 's/map00472/map00470/g' pathway_annotations.txt

#modified from trinity run_Goseq.pl
cd DESeq2/plant/Tsaopi
perl ../../../run_pathwayseq.pl --genes_single_factor plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.DE.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_pathwayseq.pl --genes_single_factor plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_pathwayseq.pl --genes_single_factor plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background plant_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

cd ../CueifongLake
perl ../../../run_pathwayseq.pl --genes_single_factor plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.DE.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_pathwayseq.pl --genes_single_factor plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_pathwayseq.pl --genes_single_factor plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background plant_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

cd ../../fungi/CueifongLake
perl ../../../run_pathwayseq.pl --genes_single_factor Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.DE.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_pathwayseq.pl --genes_single_factor Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_pathwayseq.pl --genes_single_factor Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background Fungi_CueifongLake_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

cd ../Tsaopi
perl ../../../run_pathwayseq.pl --genes_single_factor Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.DE.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_pathwayseq.pl --genes_single_factor Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.HIGH-UP.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

perl ../../../run_pathwayseq.pl --genes_single_factor Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.DE_results.P1e-3_C2.LOW-UP.subset --pathway_assignments ../../../pathway_annotations.txt --lengths ../../../seq_length --background Fungi_Tsaopi_count_matrix.HIGH_vs_LOW.DESeq2.count_matrix

cd ../../../

----------------------------------------------------------PCA-----------------------------------------------
###
#R
#experiment_design<-read.table("ExpK_experiment_design.tsv",header=T,row.names=1)
install.packages("ggbiplot")

library(ggbiplot)
library(edgeR)
library(DESeq2)
data = read.table("/home/yee/EXPK/analysis/Fungi_CueifongLake_count_matrix", header=T, row.names=1, com='')
col_ordering = c(3,4,12,2,9,1,5,6,7,11,8,10)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("HIGH", 6), rep("LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
vsd <- vst(ddsFullCountTable)
vsd_matrix<-assay(vsd)
Fungi_C_PCA<-prcomp(vsd_matrix)

ggplot(Fungi_C_PCA$x[,1:2], aes(x = PC1, y = PC2)) +geom_point(alpha = 0.5)+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()
ggsave("Fungi_CueifongLake_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/Fungi_Tsaopi_count_matrix", header=T, row.names=1, com='')
col_ordering = c(1,2,6,4,3,5,8,7,11,10,9,12)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("HIGH", 6), rep("LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
vsd <- vst(ddsFullCountTable)
vsd_matrix<-assay(vsd)
Fungi_T_PCA<-prcomp(vsd_matrix)

ggplot(Fungi_T_PCA$x[,1:2], aes(x = PC1, y = PC2)) +geom_point(alpha = 0.5)+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()
ggsave("Fungi_Tsaopi_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/plant_CueifongLake_count_matrix", header=T, row.names=1, com='')
col_ordering = c(3,4,12,2,9,1,5,6,7,11,8,10)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("HIGH", 6), rep("LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
vsd <- vst(ddsFullCountTable)
vsd_matrix<-assay(vsd)
plant_C_PCA<-prcomp(vsd_matrix)

ggplot(plant_C_PCA$x[,1:2], aes(x = PC1, y = PC2)) +geom_point(alpha = 0.5)+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()
ggsave("plant_CueifongLake_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/plant_Tsaopi_count_matrix", header=T, row.names=1, com='')
col_ordering = c(1,2,6,4,3,5,8,7,11,10,9,12)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("HIGH", 6), rep("LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
vsd <- vst(ddsFullCountTable)
vsd_matrix<-assay(vsd)
plant_T_PCA<-prcomp(vsd_matrix)

ggplot(plant_T_PCA$x[,1:2], aes(x = PC1, y = PC2)) +geom_point(alpha = 0.5)+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()
ggsave("plant_Tsaopi_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/longest_count_matrix", header=T, row.names=1, com='')
col_ordering = c(1,2,3,4,19,24,9,10,11,12,22,23,5,6,7,8,20,21,13,14,15,16,17,18)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("CueifongLake_HIGH", 6), rep("CueifongLake_LOW", 6), rep("Tsaopi_HIGH", 6), rep("Tsaopi_LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
vsd <- vst(ddsFullCountTable)
vsd_matrix<-assay(vsd)
total_PCA<-prcomp(vsd_matrix)

ggplot(total_PCA$x[,1:2], aes(x = PC1, y = PC2)) +geom_point(alpha = 0.5)+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()
ggsave("total_PCA.pdf")

library(edgeR)
library(DESeq2)
data = read.table("/home/yee/EXPK/analysis/megan_fungi_CueifongLake_count_matrix", header=T, row.names=1, com='')
col_ordering = c(3,4,12,2,9,1,5,6,7,11,8,10)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("HIGH", 6), rep("LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
ddsFullCountTable <- estimateSizeFactors(ddsFullCountTable, type = "poscounts")
vsd_megan_fungi_C <- varianceStabilizingTransformation (ddsFullCountTable)
vsd_matrix<-assay(vsd_megan_fungi_C)
megan_fungi_C_PCA<-prcomp(t(vsd_matrix))
megan_fungi_C_PCA_df<-cbind(megan_fungi_C_PCA$x,conditions)

ggplot(megan_fungi_C_PCA_df, aes(x = PC1, y = PC2,colour= conditions)) +geom_point()+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()+labs(title="megan_fungi_CueifongLake_PCA")
ggsave("megan_fungi_CueifongLake_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/megan_fungi_Tsaopi_count_matrix", header=T, row.names=1, com='')
col_ordering = c(1,2,6,4,3,5,8,7,11,10,9,12)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("HIGH", 6), rep("LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
ddsFullCountTable <- estimateSizeFactors(ddsFullCountTable, type = "poscounts")
vsd_megan_fungi_T <- varianceStabilizingTransformation (ddsFullCountTable)
vsd_matrix<-assay(vsd_megan_fungi_T)
megan_fungi_T_PCA<-prcomp(t(vsd_matrix))
megan_fungi_T_PCA_df<-cbind(megan_fungi_T_PCA$x,conditions)

ggplot(megan_fungi_T_PCA_df, aes(x = PC1, y = PC2, colour= conditions)) +geom_point()+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()+labs(title="megan_fungi_Tsaopi_PCA")
ggsave("megan_fungi_Tsaopi_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/megan_plant_CueifongLake_count_matrix", header=T, row.names=1, com='')
col_ordering = c(3,4,12,2,9,1,5,6,7,11,8,10)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("HIGH", 6), rep("LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
ddsFullCountTable <- estimateSizeFactors(ddsFullCountTable, type = "poscounts")
vsd_megan_plant_C <- varianceStabilizingTransformation(ddsFullCountTable)
vsd_matrix<-assay(vsd_megan_plant_C)
megan_plant_C_PCA<-prcomp(t(vsd_matrix))
megan_plant_C_PCA_df<-cbind(megan_plant_C_PCA$x,conditions)

ggplot(megan_plant_C_PCA_df, aes(x = PC1, y = PC2,colour= conditions)) +geom_point()+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()+labs(title="megan_plant_CueifongLake_PCA")
ggsave("megan_plant_CueifongLake_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/megan_plant_Tsaopi_count_matrix", header=T, row.names=1, com='')
col_ordering = c(1,2,6,4,3,5,8,7,11,10,9,12)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("HIGH", 6), rep("LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
ddsFullCountTable <- estimateSizeFactors(ddsFullCountTable, type = "poscounts")
vsd_megan_plant_T <- varianceStabilizingTransformation(ddsFullCountTable)
vsd_matrix<-assay(vsd_megan_plant_T)
megan_plant_T_PCA<-prcomp(t(vsd_matrix))
megan_plant_T_PCA_df<-cbind(megan_plant_T_PCA$x,conditions)

ggplot(megan_plant_T_PCA_df, aes(x = PC1, y = PC2,colour= conditions)) +geom_point()+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()+labs(title="megan_plant_Tsaopi_PCA")
ggsave("megan_plant_Tsaopi_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/megan_count_matrix", header=T, row.names=1, com='')
col_ordering = c(1,2,3,4,19,24,9,10,11,12,22,23,5,6,7,8,20,21,13,14,15,16,17,18)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("CueifongLake_HIGH", 6), rep("CueifongLake_LOW", 6), rep("Tsaopi_HIGH", 6), rep("Tsaopi_LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
ddsFullCountTable <- estimateSizeFactors(ddsFullCountTable, type = "poscounts")
vsd_megan <- varianceStabilizingTransformation(ddsFullCountTable)
vsd_matrix<-assay(vsd_megan)
megan_PCA<-prcomp(t(vsd_matrix))
megan_PCA_df<- cbind(megan_PCA$x,conditions)

ggplot(megan_PCA_df, aes(x = PC1, y = PC2, colour= conditions)) +geom_point()+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()+labs(title="megan_PCA")
ggsave("megan_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/megan_fungi_count_matrix", header=T, row.names=1, com='')
col_ordering = c(1,2,3,4,19,24,9,10,11,12,22,23,5,6,7,8,20,21,13,14,15,16,17,18)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("CueifongLake_HIGH", 6), rep("CueifongLake_LOW", 6), rep("Tsaopi_HIGH", 6), rep("Tsaopi_LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
ddsFullCountTable <- estimateSizeFactors(ddsFullCountTable, type = "poscounts")
vsd_megan_fungi <- varianceStabilizingTransformation(ddsFullCountTable)
vsd_matrix<-assay(vsd_megan_fungi)
megan_fungi_PCA<-prcomp(t(vsd_matrix))
megan_fungi_PCA_df<- cbind(megan_fungi_PCA$x,conditions)

ggplot(megan_fungi_PCA_df, aes(x = PC1, y = PC2, colour= conditions)) +geom_point()+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()+labs(title="megan_fungi_PCA")
ggsave("megan_fungi_PCA.pdf")

data = read.table("/home/yee/EXPK/analysis/megan_plant_count_matrix", header=T, row.names=1, com='')
col_ordering = c(1,2,3,4,19,24,9,10,11,12,22,23,5,6,7,8,20,21,13,14,15,16,17,18)
rnaseqMatrix = data[,col_ordering]
rnaseqMatrix = round(rnaseqMatrix)
rnaseqMatrix = rnaseqMatrix[rowSums(cpm(rnaseqMatrix) > 1) >= 2,]
conditions = data.frame(conditions=factor(c(rep("CueifongLake_HIGH", 6), rep("CueifongLake_LOW", 6), rep("Tsaopi_HIGH", 6), rep("Tsaopi_LOW", 6))))
rownames(conditions) = colnames(rnaseqMatrix)
ddsFullCountTable <- DESeqDataSetFromMatrix(
    countData = rnaseqMatrix,
    colData = conditions,
    design = ~ conditions)
ddsFullCountTable <- estimateSizeFactors(ddsFullCountTable, type = "poscounts")
vsd_megan_plant <- varianceStabilizingTransformation(ddsFullCountTable)
vsd_matrix<-assay(vsd_megan_plant)
megan_plant_PCA<-prcomp(t(vsd_matrix))
megan_plant_PCA_df<- cbind(megan_plant_PCA$x,conditions)

ggplot(megan_plant_PCA_df, aes(x = PC1, y = PC2, colour= conditions)) +geom_point()+theme_light()+theme_bw(base_size=15)+theme(axis.text.x=element_text(size=20),axis.text.y=element_text(size=20),axis.title = element_text(size = 40))+ stat_ellipse()+labs(title="megan_plant_PCA")
ggsave("megan_plant_PCA.pdf")



------------------------------------------------PERMANOVA----------------------------------------------
#R
vsd_matrix<-assay(vsd_Fungi_C)
permanova_conditions = data.frame(temperature=factor(c(rep("HIGH", 6), rep("LOW", 6))))
permanova_Fungi_C<-adonis2(formula = t(vsd_matrix) ~ temperature, permanova_conditions)
#Permutation test for adonis under reduced model
#Permutation: free
#Number of permutations: 999

#adonis2(formula = t(vsd_matrix) ~ temperature, data = permanova_conditions)
#         Df   SumOfSqs      R2      F Pr(>F)   
#Model     1 7.7674e-05 0.28642 4.0138  0.004 **
#Residual 10 1.9352e-04 0.71358                 
#Total    11 2.7119e-04 1.00000                 
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

vsd_matrix<-assay(vsd_Fungi_T)
permanova_conditions = data.frame(temperature=factor(c(rep("HIGH", 6), rep("LOW", 6))))
permanova_Fungi_T <-adonis2(formula = t(vsd_matrix) ~ temperature, permanova_conditions)

#Permutation test for adonis under reduced model
#Permutation: free
#Number of permutations: 999

#adonis2(formula = t(vsd_matrix) ~ temperature, data = permanova_conditions)
#         Df   SumOfSqs      R2      F Pr(>F)    
#Model     1 0.00016626 0.26044 3.5216  0.001 ***
#Residual 10 0.00047211 0.73956                  
#Total    11 0.00063836 1.00000                  
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

vsd_matrix<-assay(vsd_plant_C)
permanova_conditions = data.frame(temperature=factor(c(rep("HIGH", 6), rep("LOW", 6))))
permanova_plant_C <-adonis2(formula = t(vsd_matrix) ~ temperature, permanova_conditions)

#Permutation test for adonis under reduced model
#Permutation: free
#Number of permutations: 999

#adonis2(formula = t(vsd_matrix) ~ temperature, data = permanova_conditions)
#         Df   SumOfSqs      R2      F Pr(>F)  
#Model     1 0.00067771 0.24117 3.1782  0.016 *
#Residual 10 0.00213235 0.75883                
#Total    11 0.00281007 1.00000                
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

vsd_matrix<-assay(vsd_plant_T)
permanova_conditions = data.frame(temperature=factor(c(rep("HIGH", 6), rep("LOW", 6))))
permanova_plant_T <-adonis2(formula = t(vsd_matrix) ~ temperature, permanova_conditions)

#Permutation test for adonis under reduced model
#Permutation: free
#Number of permutations: 999

#adonis2(formula = t(vsd_matrix) ~ temperature, data = #permanova_conditions)
#         Df  SumOfSqs      R2     F Pr(>F)
#Model     1 0.0003306 0.09886 1.097  0.288
#Residual 10 0.0030140 0.90114             
#Total    11 0.0033447 1.00000


permanova_conditions = data.frame(site=factor(c(rep("CueifongLake", 12),rep("HIGH", 12))), temperature=factor(c(rep("HIGH", 6), rep("LOW", 6), rep("HIGH", 6), rep("LOW", 6))))

adonis2(formula = vsd_matrix ~ site*temperature, permanova_conditions)

# 1. 載入必要套件
library(edgeR)
library(vegan)

# 2. 將 raw count matrix 輸入 edgeR 格式
# counts_mat：基因 × 樣本的 raw count matrix
data = read.table("/home/yee/EXPK/analysis/megan_fungi_CueifongLake_count_matrix", header=T, row.names=1, com='')
dge_megan_fungi_C <- DGEList(counts = data)
data = read.table("/home/yee/EXPK/analysis/megan_fungi_Tsaopi_count_matrix", header=T, row.names=1, com='')
dge_megan_fungi_T <- DGEList(counts = data)
data = read.table("/home/yee/EXPK/analysis/megan_plant_CueifongLake_count_matrix", header=T, row.names=1, com='')
dge_megan_plant_C <- DGEList(counts = data)
data = read.table("/home/yee/EXPK/analysis/megan_plant_Tsaopi_count_matrix", header=T, row.names=1, com='')
dge_megan_plant_T <- DGEList(counts = data)
data = read.table("/home/yee/EXPK/analysis/megan_count_matrix", header=T, row.names=1, com='')
dge_megan <- DGEList(counts = data)
data = read.table("/home/yee/EXPK/analysis/megan_fungi_count_matrix", header=T, row.names=1, com='')
dge_megan_fungi <- DGEList(counts = data)
data = read.table("/home/yee/EXPK/analysis/megan_plant_count_matrix", header=T, row.names=1, com='')
dge_megan_plant <- DGEList(counts = data)

# 3. 計算 normalization factor
dge_megan_fungi_C <- calcNormFactors(dge_megan_fungi_C)
dge_megan_fungi_T <- calcNormFactors(dge_megan_fungi_T)
dge_megan_plant_C <- calcNormFactors(dge_megan_plant_C)
dge_megan_plant_T <- calcNormFactors(dge_megan_plant_T)
dge_megan <- calcNormFactors(dge_megan)
dge_megan_fungi <- calcNormFactors(dge_megan_fungi)
dge_megan_plant <- calcNormFactors(dge_megan_plant)

# 4. 將 counts 轉為 CPM（counts per million），避免極端值影響
norm_counts_megan_fungi_C <- cpm(dge_megan_fungi_C, normalized.lib.sizes = TRUE)
norm_counts_megan_fungi_T <- cpm(dge_megan_fungi_T, normalized.lib.sizes = TRUE)
norm_counts_megan_plant_C <- cpm(dge_megan_plant_C, normalized.lib.sizes = TRUE)
norm_counts_megan_plant_T <- cpm(dge_megan_plant_T, normalized.lib.sizes = TRUE)
norm_counts_megan <- cpm(dge_megan, normalized.lib.sizes = TRUE)
norm_counts_megan_fungi <- cpm(dge_megan_fungi, normalized.lib.sizes = TRUE)
norm_counts_megan_plant <- cpm(dge_megan_plant, normalized.lib.sizes = TRUE)

# 5. 轉為相對 abundance（避免距離出錯）
rel_counts_megan_fungi_C <- t(apply(norm_counts_megan_fungi_C, 2, function(x) x / sum(x)))
rel_counts_megan_fungi_T <- t(apply(norm_counts_megan_fungi_T, 2, function(x) x / sum(x)))
rel_counts_megan_plant_C <- t(apply(norm_counts_megan_plant_C, 2, function(x) x / sum(x)))
rel_counts_megan_plant_T <- t(apply(norm_counts_megan_plant_T, 2, function(x) x / sum(x)))
rel_counts_megan <- t(apply(norm_counts_megan, 2, function(x) x / sum(x)))
rel_counts_megan_fungi <- t(apply(norm_counts_megan_fungi, 2, function(x) x / sum(x)))
rel_counts_megan_plant <- t(apply(norm_counts_megan_plant, 2, function(x) x / sum(x)))

# 6. 計算距離矩陣（例如 Bray-Curtis）
#dist_mat_megan_fungi_C <- vegdist(t(rel_counts_megan_fungi_C), method = "bray")  # 注意要 transpose

# 7. 執行 PERMANOVA（adonis2 比 adonis 更推薦）
permanova_conditions = data.frame(temperature=factor(c(rep("HIGH", 6), rep("LOW", 6))))
permanova_megan_fungi_C <-adonis2(formula = rel_counts_megan_fungi_C ~ temperature, permanova_conditions)

#Permutation test for adonis under reduced model
#Permutation: free
#Number of permutations: 999

#adonis2(formula = rel_counts_megan_fungi_C ~ temperature, data = permanova_conditions)
#         Df SumOfSqs      R2     F Pr(>F)
#Model     1    0.329 0.08265 0.901  0.555
#Residual 10    3.652 0.91735             
#Total    11    3.981 1.00000

permanova_conditions = data.frame(temperature=factor(c(rep("HIGH", 6), rep("LOW", 6))))
permanova_megan_fungi_T <-adonis2(formula = rel_counts_megan_fungi_T ~ temperature, permanova_conditions)

#Permutation test for adonis under reduced model
#Permutation: free
#Number of permutations: 999

#adonis2(formula = rel_counts_megan_fungi_T ~ temperature, data = permanova_conditions)
#         Df SumOfSqs      R2      F Pr(>F)   
#Model     1   1.4184 0.33478 5.0327  0.006 **
#Residual 10   2.8185 0.66522                 
#Total    11   4.2369 1.00000                 
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

permanova_conditions = data.frame(temperature=factor(c(rep("HIGH", 6), rep("LOW", 6))))
permanova_megan_plant_C <-adonis2(formula = rel_counts_megan_plant_C ~ temperature, permanova_conditions)

#Permutation test for adonis under reduced model
#Permutation: free
#Number of permutations: 999

#adonis2(formula = rel_counts_megan_plant_C ~ temperature, data = permanova_conditions)
#         Df SumOfSqs      R2      F Pr(>F)
#Model     1  0.03598 0.08968 0.9852  0.383
#Residual 10  0.36526 0.91032              
#Total    11  0.40124 1.00000

permanova_conditions = data.frame(temperature=factor(c(rep("HIGH", 6), rep("LOW", 6))))
permanova_megan_plant_T <-adonis2(formula = rel_counts_megan_plant_T ~ temperature, permanova_conditions)

#Permutation test for adonis under reduced model
#Permutation: free
#Number of permutations: 999

#adonis2(formula = rel_counts_megan_plant_T ~ temperature, data = permanova_conditions)
#         Df SumOfSqs     R2      F Pr(>F)
#Model     1  0.05965 0.1492 1.7537  0.132
#Residual 10  0.34014 0.8508              
#Total    11  0.39979 1.0000

permanova_conditions = data.frame(site=factor(c(rep("CueifongLake", 12),rep("Tsaopi", 12))), temperature=factor(c(rep("HIGH", 6), rep("LOW", 6), rep("HIGH", 6), rep("LOW", 6))))
permanova_megan <-adonis2(formula = rel_counts_megan ~ site*temperature, permanova_conditions, by="terms")

#Permutation test for adonis under reduced model
#Terms added sequentially (first to last)
#Permutation: free
#Number of permutations: 999

#adonis2(formula = rel_counts_megan ~ site * temperature, data = permanova_conditions, by = "terms")
#                 Df SumOfSqs      R2      F Pr(>F)
#site              1  0.06850 0.06894 1.6481  0.088 .
#temperature       1  0.04458 0.04487 1.0727  0.339
#site:temperature  1  0.04931 0.04963 1.1865  0.260
#Residual         20  0.83123 0.83656
#Total            23  0.99363 1.00000
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

permanova_conditions = data.frame(site=factor(c(rep("CueifongLake", 12),rep("Tsaopi", 12))), temperature=factor(c(rep("HIGH", 6), rep("LOW", 6), rep("HIGH", 6), rep("LOW", 6))))
permanova_megan_fungi <-adonis2(formula = rel_counts_megan_fungi ~ site*temperature, permanova_conditions, by="terms")

#Permutation test for adonis under reduced model
#Terms added sequentially (first to last)
#Permutation: free
#Number of permutations: 999

#adonis2(formula = rel_counts_megan_fungi ~ site * temperature, data = permanova_conditions, by = "terms")
#                 Df SumOfSqs      R2      F Pr(>F)   
#site              1   1.0680 0.11550 2.9301  0.002 **
#temperature       1   0.4359 0.04714 1.1958  0.184   
#site:temperature  1   0.4526 0.04895 1.2417  0.171   
#Residual         20   7.2899 0.78841                 
#Total            23   9.2464 1.00000                 
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

permanova_conditions = data.frame(site=factor(c(rep("CueifongLake", 12),rep("Tsaopi", 12))), temperature=factor(c(rep("HIGH", 6), rep("LOW", 6), rep("HIGH", 6), rep("LOW", 6))))
permanova_megan_plant <-adonis2(formula = rel_counts_megan_plant ~ site*temperature, permanova_conditions, by="terms")

#####
----------------------------------------------------MEGAN-----------------------------------------------
wget https://software-ab.cs.uni-tuebingen.de/download/megan6/MEGAN_Community_unix_6_25_10.sh

wget https://software-ab.cs.uni-tuebingen.de/download/megan6/megan-map-Feb2022.db.zip
unzip megan-map-Feb2022.db.zip
wget https://software-ab.cs.uni-tuebingen.de/download/megan6/megan-nucl-Feb2022.db.zip
unzip megan-nucl-Feb2022.db.zip

export FONTCONFIG_PATH=/etc/fonts
sh MEGAN_Community_unix_6_25_10.sh

../../megan/tools/blast2rma  -i nr_aln -f BlastTab -o nr_aln_noweighted.rma -mdb ../../megan-map-Feb2022.db -t 72
../../megan/tools/rma2info -i nr_aln_noweighted.rma -c2c Taxonomy -r2c Taxonomy -p true -r true -u false > megan_noweighted_taxonomy

../../megan/tools/blast2rma  -i nr_aln -f BlastTab -o nr_aln.rma -mdb ../../megan-map-Feb2022.db -alg weighted -t 72
../../megan/tools/rma2info -i nr_aln.rma -c2c Taxonomy -r2c Taxonomy -p true -r true -u false > megan_taxonomy


#grep 'Fungi' nr_taxa_info | cut -f1 | sort | uniq -c > test
#grep -Ff <(awk '{print$2}' test) nr_taxa_info | cut -f1 | sort | uniq -c > tt
#paste -d ' ' tt test | awk '{print log($3/(($1-$3)+1))}' >ttt
#grep -A1 --no-group-separator -Ff <(paste -d ' ' tt test ttt | sort -nk5 | tail -n15 | awk '{print $2}') cd-hit-est >>megan_test.fasta

diamond blastx -d /home/yee/nr_db -q megan_test.fasta -o megan_test.aln.txt --sensitive -p 72 -b 20 -c 1 -e 0.0000000001 --top 5 --outfmt 6
diamond blastx -d /home/yee/nr_db -q megan_test.fasta -o megan_test.aln.xml --sensitive -p 72 -b 20 -c 1 -e 0.0000000001 --top 5 --outfmt 5

../../megan/tools/blast2rma  -i megan_test.aln.txt -f BlastTab -o megan_test.aln.txt.rma -mdb ../../megan-map-Feb2022.db -alg weighted -t 72
../../megan/tools/rma2info -i megan_test.aln.txt.rma -c2c Taxonomy -r2c Taxonomy -p true -r true -u false > megan_txt_taxonomy

../../megan/tools/blast2rma  -i megan_test.aln.txt -f BlastTab -o megan_test.aln.xml.rma -mdb ../../megan-map-Feb2022.db -alg weighted -t 72
../../megan/tools/rma2info -i megan_test.aln.xml.rma -c2c Taxonomy -r2c Taxonomy -p true -r true -u false > megan_xml_taxonomy


wget https://software-ab.cs.uni-tuebingen.de/download/megan7/megan-nr-r1a.zip
unzip megan-nr-r1a.zip
../../megan/tools/blast2rma  -i megan_test.aln.txt -f BlastTab -o megan_test.7.rma -mdb ../../megan-nr-r1a.mdb -alg weighted -t 72
../../megan/tools/rma2info -i megan_test.aln.txt.rma -c2c Taxonomy -r2c Taxonomy -p true -r true -u false > megan_test_7_taxonomy

../../megan/tools/blast2rma  -i nr_aln -f BlastTab -o nr_aln_7.rma -mdb ../../megan-nr-r1a.mdb -alg weighted -t 72
../../megan/tools/rma2info -i nr_aln_7.rma -c2c Taxonomy -r2c Taxonomy -p true -r true -u false > megan_7_taxonomy

../../megan/tools/read-extractor -i nr_aln.rma  -o test_extract -c Taxonomy -n Fungi -b


----------------------taxa table------------------------------sed -n 's/.*\(<[^ ]*.*>\).*/\1/p' megan_7_taxonomy | sort | uniq -c
# 314486 <animals>
#    315 <beetles>
#    501 <family Mollisiaceae>
#    809 <ferns>
#    242 <gastropods>

sed 's/ <[A-z ]\+>//' megan_7_taxonomy > megan_7_taxonomy_cln

#grep -P "^K[0-9]" megan_7_taxonomy | cut -f1,3 | sed -e 's/;$//' -e 's/; /\t/g' -e 's/Not assigned/unknown/' | awk 'BEGIN{FS=OFS="\t"}{printf "%s",$0; for(i=NF+1;i<=30;i++) printf "\t%s","unknown";if(i=30) printf "\n"}' | cut -f2 --complement > megan_taxa_table

#echo -e "Hominidae" | taxonkit --data-dir /home/yee name2taxid | cut -f2|taxonkit --data-dir /home/yee lineage -R | cut -f3 | sed -e 's/;/\t/g'> tmp

#awk 'BEGIN{FS="\t"}{
for(i=1;i<=NF;i++){ 
if(index($i,"unknown")>0){ 
print i-2;
break; 
}
}
}' megan_taxa_table > test

#awk -F $'\t' '
FNR==1 { file_count++ }  # Count how many files are processed
{ 
	if (file_count == 1) {
		for (i=1; i<=NF;i++){
			if(i==1){
				map[i] = "no rank";
			}else{
				map[i] = map[i-1]";"$i;
			}
		}
	next;
	}
	if($1==0){
		print "Not assigned"
	}else{
		print map[$1];
	}
}' tmp test > ttt

#grep -P "^K[0-9]" megan_7_taxonomy | cut -f3 | sed -e 's/;$//' -e 's/; /\t/g' | awk 'BEGIN{FS="\t"}{print $NF}' | taxonkit --data-dir /home/yee name2taxid | cut -f2|taxonkit --data-dir /home/yee lineage -R | cut -f3 > test

#sed -n 's/.*\(no rank[^ ]*.*kingdom\).*/\1/p' test | sort | uniq -c
#no rank;superkingdom;clade;kingdom
# superkingdom;clade;kingdom;phylum;class;order;family;no rank

#sed -n 's/.*\(;kingdom[^ ]*.*;phylum\).*/\1/p' test | sort | uniq -c
#kingdom;clade;clade;clade;clade;clade;phylum

#echo -e "no rank;superkingdom;clade;Viruses superkingdom;kingdom;clade;clade;clade;clade;clade;no rank;subkingdom;phylum;clade;clade;subphylum;clade;clade;clade;clade;no rank;superclass;clade;clade;clade;clade;clade;clade;clade;clade;clade;clade;clade;class;clade;clade;clade;clade;clade;clade;subclass;infraclass;clade;no rank;cohort;subcohort;clade;clade;clade;clade;clade;clade;superorder;order;suborder;infraorder;parvorder;clade;clade;no rank;clade;superfamily;family;clade;subfamily;clade;no rank;tribe;subtribe;genus;no rank;species"


#grep -P "^K[0-9]" megan_7_taxonomy | cut -f3 | sed -e 's/;$//' -e 's/; /;/g' -e 's/NCBI;//'> taxa_name 
#mapfile -t taxa_name < taxa_name

#grep -P "^K[0-9]" megan_7_taxonomy | cut -f3 | sed -e 's/;$//' -e 's/; /\t/g' | awk 'BEGIN{FS="\t"}{print $NF}' | taxonkit --data-dir /home/yee name2taxid | cut -f2|taxonkit --data-dir /home/yee lineage -R | cut -f3 > taxa_level 
#mapfile -t taxa_level < taxa_level

#IFS=';' read -ra ref <<< "no rank;superkingdom;clade;Viruses superkingdom;kingdom;clade;clade;clade;clade;clade;no rank;subkingdom;phylum;clade;clade;subphylum;clade;clade;clade;clade;no rank;superclass;clade;clade;clade;clade;clade;clade;clade;clade;clade;clade;clade;class;clade;clade;clade;clade;clade;clade;subclass;infraclass;clade;no rank;cohort;subcohort;clade;clade;clade;clade;clade;clade;superorder;order;suborder;infraorder;parvorder;clade;clade;no rank;clade;superfamily;family;clade;subfamily;clade;no rank;tribe;subtribe;genus;no rank;species"


#while IFS=";" read -r -a taxa;
#do
#	for index in "${!taxa[@]}";
#		do
#			echo "${taxa[index]}" |taxonkit --data-dir /home/yee name2taxid| cut-f2 | taxonkit --data-dir /home/yee lineage -R
#		done
#	echo "${#taxa[@]}"
#done< taxa_name

#taxa_result=()
#while IFS= read -r  taxa;
#do
#	taxaname=$(echo ${taxa}| awk 'BEGIN{FS=";"}{print $NF}')
#taxanumber=$(echo ${taxaname}| taxonkit --data-dir /home/yee name2taxid | wc -l)
#	taxa_result+=("${taxaname}\t${taxanumber}")
#done< taxa_name
#for row in "${taxa_result[@]}";
#	do
#echo -e "$row" >> taxaid_check
#done


#grep -P "^K[0-9]" megan_7_taxonomy_cln | grep "Fungi" | cut -f3 | sed -e 's/;$//' -e 's/; /;/g' -e 's/NCBI;//' > fungi_taxa_name
#grep -P "^K[0-9]" megan_7_taxonomy_cln | cut -f3 | grep "Fungi" | sed -e 's/;$//' -e 's/; /\t/g' | awk 'BEGIN{FS="\t"}{print $NF}' | taxonkit --data-dir /home/yee name2taxid | cut -f2|taxonkit --data-dir /home/yee lineage -R | cut -f3 > fungi_taxa_level

#Fungi
#Glomeromycetes

#grep -P "^K[0-9]" megan_7_taxonomy_cln | grep "Embryophyta" | cut -f3 | sed -e 's/;$//' -e 's/; /;/g' -e 's/NCBI;//' > plant_taxa_name
#grep -P "^K[0-9]" megan_7_taxonomy_cln| grep -P "Embryophyta" | cut -f3 | sed -e 's/;$//' -e 's/; /\t/g' | awk 'BEGIN{FS="\t"}{print $NF}' | taxonkit --data-dir /home/yee name2taxid | cut -f2|taxonkit --data-dir /home/yee lineage -R | cut -f2 > plant_taxa_level

#Polypodiidae	1521262

#grep -P "^K[0-9]" megan_7_taxonomy_cln| grep -P "Embryophyta"| cut -f3 | sed -e 's/;$//' -e 's/; /\t/g' | awk 'BEGIN{FS="\t"}{print $NF}' | while IFS= read -r taxaname; do     if [[ "$taxaname" == "Polypodiidae" ]]; then         taxaid="1521262";     else         taxaid=$(echo "$taxaname" | taxonkit --data-dir /home/yee name2taxid | cut -f2);     fi;     echo "$taxaid" | taxonkit --data-dir /home/yee lineage -R | cut -f3 >> plant_taxa_level; done


#grep -P "^K[0-9]" megan_7_taxonomy_cln | grep -P "Embryophyta" | tail | sed -e 's/;$//' -e 's/; /\t/g' | awk '{if(NR>1)print ""; print $0}' | parallel --pipe --recend '\n\n' -j 72 " 
while IFS= read -r read; do  
    gene=\$(echo \"\$read\" | awk -F\"\t\" '{print \$1}')
    taxaname=\$(echo \"\$read\" | awk -F\"\t\" '{print \$NF}')
    if [[ \"\$taxaname\" == \"Polypodiidae\" ]]; then
        taxaid=\"1521262\"
    else
        taxaid=\$(echo \"\$taxaname\" | taxonkit --data-dir /home/yee name2taxid | cut -f2)
    fi
    lineage=\$(echo \"\$taxaid\" | taxonkit --data-dir /home/yee lineage -R | cut -f3)
    echo -e \"\${gene}\t\${lineage}\"
done
" | sed '/^\s*$/d'>> test_plant_taxa_level


grep -P "^K[0-9]" megan_7_taxonomy_cln| cut -f1,3 | sed -e 's/;$//' -e 's/; /\t/g'|awk -F "[\t]" '{print $1"\t"$NF}'> megan_taxa_import

cut -f2 megan_taxa_import | sort | uniq | taxonkit --data-dir /home/yee name2taxid > megan_taxa_ID

05:34:45.291 [WARN] multiple TaxIds found for 'Actinobacteria'
05:34:45.291 [WARN] multiple TaxIds found for 'Aculeata'
05:34:45.292 [WARN] multiple TaxIds found for 'Aphelenchoididae'
05:34:45.292 [WARN] multiple TaxIds found for 'Archaea'
05:34:45.292 [WARN] multiple TaxIds found for 'Bacteria'
05:34:45.292 [WARN] multiple TaxIds found for 'Bacteroidetes'
05:34:45.292 [WARN] multiple TaxIds found for 'Bdelloidea'
05:34:45.292 [WARN] multiple TaxIds found for 'Chloroflexi'
05:34:45.292 [WARN] multiple TaxIds found for 'Coccomyxa'
05:34:45.292 [WARN] multiple TaxIds found for 'Cyanobacteria'
05:34:45.292 [WARN] multiple TaxIds found for 'Euthyneura'
05:34:45.292 [WARN] multiple TaxIds found for 'Firmicutes'
05:34:45.292 [WARN] multiple TaxIds found for 'Fungi'
05:34:45.292 [WARN] multiple TaxIds found for 'Glomeromycetes'
05:34:45.292 [WARN] multiple TaxIds found for 'Gnathifera'
05:34:45.292 [WARN] multiple TaxIds found for 'Gnathostomata'
05:34:45.292 [WARN] multiple TaxIds found for 'Planctomycetes'
05:34:45.292 [WARN] multiple TaxIds found for 'Polyphaga'
05:34:45.293 [WARN] multiple TaxIds found for 'Polypodiidae'
05:34:45.293 [WARN] multiple TaxIds found for 'Primates'
05:34:45.293 [WARN] multiple TaxIds found for 'Proteobacteria'
05:34:45.293 [WARN] multiple TaxIds found for 'Pterygota'
05:34:45.293 [WARN] multiple TaxIds found for 'Rothia'
05:34:45.293 [WARN] multiple TaxIds found for 'Theria'
05:34:45.293 [WARN] multiple TaxIds found for 'Verrucomicrobia'
05:34:45.293 [WARN] multiple TaxIds found for 'Vertebrata'
05:34:45.293 [WARN] multiple TaxIds found for 'Viruses'

#Replicate: Actinobacteria,Aphelenchoididae,Archaea, Cyanobacteria,Fungi, Glomeromycetes,Primates,Proteobacteria,Verrucomicrobia, Viruses
#Need check: Aculeata,Bacteria,Bacteroidetes,Bdelloidea,Chloroflexi, Coccomyxa,Euthyneura,Firmicutes,Gnathifera, Gnathostomata,Planctomycetes,Polyphaga,Polypodiidae,Pterygota, Rothia,Theria,Vertebrata

#Aculeata	7434
#Bacteria	2
#Bacteroidetes 976
#Bdelloidea	44578
#Chloroflexi	200795
#Coccomyxa	41891
#Euthyneura 216307
#Firmicutes	1239
#Gnathifera	2697496
#Gnathostomata	7776
#Planctomycetes	203682
#Polyphaga	41084
#Polypodiidae	1521262
#Pterygota	7496
#Rothia	32207
#Theria	32525
#Vertebrata	7742

grep -P "\t$" megan_taxa_ID
#Acidobacteria bacterium	
#Cyanobacteria/Melainabacteria group	
#Helotiales sp. DMI_Dod_QoI	
#NCBI	
#Not assigned	
#Prevotella nanceiensis	
#unclassified Acidobacteria	
#unclassified Chloroflexi	
#unclassified Coccomyxa (in: Viridiplantae)	
#unclassified Rothia (in: Bacteria)

sed -i e 's/Acidobacteria bacterium\t/Acidobacteria bacterium\t57723/' -e 's/Cyanobacteria\/Melainabacteria group\t/Cyanobacteria\/Melainabacteria group\t1798711/' -e 's/Helotiales sp. DMI_Dod_QoI\t/Helotiales sp. DMI_Dod_QoI \t2728926/' -e 's/Prevotella nanceiensis\t/Prevotella nanceiensis\t425941/' -e 's/unclassified Acidobacteria\t/unclassified Acidobacteria\t57723/' -e 's/unclassified Chloroflexi\t/unclassified Chloroflexi\t200795/' -e 's/unclassified Coccomyxa (in: Viridiplantae)\t/unclassified Coccomyxa (in: Viridiplantae)\t41891/' -e 's/unclassified Rothia (in: Bacteria)\t/unclassified Rothia (in: Bacteria)\t32207/' -e 's/NCBI\t/NCBI\tNA/' -e 's/Not assigned\t/Not assigned\tNA/' megan_taxa_ID

#while read -r ID;
#do
#	taxaID=$(echo "$ID" | awk -F "\t" '{print$2}')
#	if [[ "$taxaID"!="NA" ]]; then 
#taxa_level=$(echo "$taxaID" | taxonkit --data-dir /home/yee lineage -R) 
#else taxa_level="NA\tNot assigned\tNot assigned";
#	fi
#	echo -e "$taxa_level" >>megan_taxa_level
#done< megan_taxa_ID

awk -F"\t" '{
    if ($2 == "NA") {
        print $2 "\t" $1 "\tNot assigned\tNot assigned";
    } else {
        print $2 "\t" $1;
    }
}' megan_taxa_ID | sort -k1,1 | taxonkit --data-dir /home/yee lineage -R | awk 'BEGIN{OFS="\t"}  {print $0}' > megan_taxa_level

awk -F $'\t' '
FNR==1 { file_count++ }  # Count how many files are processed

{ 
if (file_count == 1) {
           map1[$2][1] = $3;  # Store data from each file using file_count as an index
map1[$2][2] = $4;  # Store data from each file using file_count as an index
next;
   }

    printf "%s\t",$1;  # Print the current line from file1.txt
	taxon= $2; 
    if (taxon in map1) { 
printf "%s\t%s\t", map1[taxon][1], map1[taxon][2]; 
}
    print "";  # Newline
}'  megan_taxa_level megan_taxa_import > megan_taxa_build

# 將 template 轉為陣列
IFS=';' read -ra ref <<< "no rank;superkingdom;clade;Viruses superkingdom;kingdom;clade;clade;clade;clade;clade;no rank;subkingdom;phylum;clade;clade;subphylum;clade;clade;clade;clade;no rank;superclass;clade;clade;clade;clade;clade;clade;clade;clade;clade;clade;clade;class;clade;clade;clade;clade;clade;clade;subclass;infraclass;clade;no rank;cohort;subcohort;clade;clade;clade;clade;clade;clade;superorder;order;suborder;infraorder;parvorder;clade;clade;no rank;clade;superfamily;family;clade;subfamily;clade;no rank;tribe;subtribe;genus;no rank;species"

mapfile -t taxa_level_lines < <(cut -f3 megan_taxa_build)
mapfile -t taxa_name_lines < <(cut -f2 megan_taxa_build)
# 處理每一行
for idx in "${!taxa_level_lines[@]}"; do
# 拆分每行
IFS=';' read -ra level <<< "${taxa_level_lines[idx]}"
    IFS=';' read -ra name <<< "${taxa_name_lines[idx]}"
    
    tgt_idx=0
    output=()

    for (( i=0; i<${#ref[@]}; i++ )); do
        if [[ $tgt_idx -lt ${#level[@]} && "${ref[i]}" == "${level[tgt_idx]}" ]]; then
            output+=("${name[tgt_idx]}")
            ((tgt_idx++))
        else
            output+=("Not assigned")
        fi
    done

    # 輸出該行結果
    (IFS=$'\t'; echo -e "${output[*]}") >>megan_taxa_table
done

grep -vwFf <(cut -f1 megan_taxa_build | sed 's/_i[0-9]\+//') longest_count_matrix | grep -P "^K[0-9]" | cut -f1 > no_annotationid
printf '\t%s' "${ref[@]}" > megan_taxa_table_total
echo  "" >> megan_taxa_table_total
paste <(cut -f1 megan_taxa_build | sed 's/^>//; s/_i[0-9]\+$//') megan_taxa_table >> megan_taxa_table_total
awk -v arr="${#ref[@]}" '{printf "%s",$0; for (i=1; i<=arr; i++ ) {printf"\t%s","Not assigned"} print ""}' no_annotationid >>megan_taxa_table_total

awk -F "\t" '{print $1"\t"$6"\t"$14"\t"$35"\t"$55"\t"$64"\t"$71"\t"$73}' megan_taxa_table_total > megan_taxa_table_7level

----------------------relative abundance----------------------
#R
library("ggplot2")
library("edgeR")
rowdata<-read.table("longest_count_matrix")
countmatrix<-rowdata[rowSums(cpm(rowdata)>1)>=2,]
countmatrix<-countmatrix[,order(colnames(countmatrix))]
sample_inform<-read.table("ExpK_experiment_design.tsv",header=TRUE,row.names=1)
sample_inform<-sample_inform[,c(-1,-4)]
sample_inform$type<-paste(sample_inform[,1],sample_inform[,2],sep="_")
sample_inform<-sample_inform[order(rownames(sample_inform)),]

megan_taxa<-read.table("megan_taxa_table_7level",sep="\t",header=TRUE,row.names=1)
gene_table<-cbind(countmatrix,megan_taxa[which(rownames(megan_taxa)%in%rownames(countmatrix)),])

library(tidyr)
fungi_class_list<-as.data.frame(table(gene_table$class[which(gene_table$kingdom=="Fungi")],useNA="ifany"),stringsAsFactors=FALSE)[,1]
fungi_class_relativeabundance_fungi_df<-NULL
for(i in fungi_class_list){
	fungi_class_relativeabundance_fungi_df<-rbind(fungi_class_relativeabundance_fungi_df,colSums(gene_table[intersect(which(gene_table[,27]==i),which(gene_table[,25]== "Fungi")),1:24]))
}

rownames(fungi_class_relativeabundance_fungi_df)<-fungi_class_list
fungi_class_relativeabundance_fungi<-as.data.frame(pivot_longer(as.data.frame(fungi_class_relativeabundance_fungi_df),col=colnames(fungi_class_relativeabundance_fungi_df),names_to="sample",values_to="abundance"))
fungi_class_relativeabundance_fungi$class<-unlist(lapply(fungi_class_list,function(x) rep(x,24)))
fungi_class_relativeabundance_fungi<-cbind(fungi_class_relativeabundance_fungi,apply(sample_inform,2,function(x)rep(x,16)))

random_color <- function(color_number) {
  colors <- character(color_number)
  for(i in 1:color_number) {
    hex <- paste(
      unlist(lapply(replicate(3, sample(0:255, 1)),
                    function(x) sprintf("%02X", x))),
      collapse = ""
    )
    colors[i] <- paste0("#", hex)
  }
  return(colors)
}

color<-random_color(16)
ggplot(fungi_class_relativeabundance_fungi, aes(x = sample, y = abundance))+geom_bar(aes(fill = class), position = "fill", stat = "identity")+ scale_fill_manual(values =color)+xlab(label = NULL)+theme(legend.title = element_text(size = 18, face = "bold"),legend.text = element_text(size = 16, color = "black"),axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5),axis.text.y = element_text(size = 16),axis.title = element_text(size = 20),strip.text.x = element_text(size = 18))+scale_y_continuous(breaks = c(0,0.25,0.5,0.75,1) ,labels = c("0%","25%","50%","75%","100%"))+ylab(label="Relative abundance (Fungi count / total Fungi count)")
ggsave("fungi_class_relativeabundance_fungi.pdf",height=10)

fungi_class_relativeabundance_total<-as.data.frame(cbind(fungi_class_relativeabundance_fungi[,1],fungi_class_relativeabundance_fungi[,2]/colSums(countmatrix),fungi_class_relativeabundance_fungi[,3:6]))
colnames(fungi_class_relativeabundance_total)<- colnames(fungi_class_relativeabundance_fungi)
ggplot(fungi_class_relativeabundance_total, aes(x = sample, y = abundance))+geom_bar(aes(fill = class), position = "stack", stat = "identity")+ scale_fill_manual(values =color)+xlab(label = NULL)+theme(legend.title = element_text(size = 18, face = "bold"),legend.text = element_text(size = 16, color = "black"),axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5),axis.text.y = element_text(size = 16),axis.title = element_text(size = 20),strip.text.x = element_text(size = 18))+ scale_y_continuous(breaks = c(0, 0.0025, 0.005, 0.0075, 0.01) ,labels = c("0%","0.25%","0.5%","0.75%","1%"))+ylab(label="Relative abundance (Fungi count / total count)")
ggsave("fungi_class_relativeabundance_total.pdf",height=10)


kingdom_list<-as.data.frame(table(gene_table$kingdom,useNA="ifany"),stringsAsFactors=FALSE)[,1]
kingdom_relativeabundance_df<-NULL
for(i in kingdom_list){
	kingdom_relativeabundance_df<-rbind(kingdom_relativeabundance_df,colSums(gene_table[which(gene_table[,25]==i),1:24]))
}

rownames(kingdom_relativeabundance_df)<-kingdom_list
kingdom_relativeabundance <-as.data.frame(pivot_longer(as.data.frame(kingdom_relativeabundance_df),col=colnames(kingdom_relativeabundance_df),names_to="sample",values_to="abundance"))
kingdom_relativeabundance$kingdom<-unlist(lapply(kingdom_list,function(x) rep(x,24)))
kingdom_relativeabundance<-cbind(kingdom_relativeabundance,apply(sample_inform,2,function(x)rep(x,8)))
color<-random_color(8)
ggplot(kingdom_relativeabundance, aes(x = sample, y = abundance))+geom_bar(aes(fill = kingdom), position = "fill", stat = "identity")+ scale_fill_manual(values =color)+xlab(label = NULL)+theme(legend.title = element_text(size = 18, face = "bold"),legend.text = element_text(size = 16, color = "black"),axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5),axis.text.y = element_text(size = 16),axis.title = element_text(size = 20),strip.text.x = element_text(size = 18))+scale_y_continuous(breaks = c(0,0.25,0.5,0.75,1) ,labels = c("0%","25%","50%","75%","100%"))+ylab(label="Relative abundance (Kingdom)")
ggsave("kingdom_relative_abundance.pdf")

sum(gene_table[which(gene_table[,25]=="Fungi"),1:24])/sum(gene_table[,1:24])
#0.008510771
sum(gene_table[which(gene_table[,25]=="Not assigned"),1:24])/sum(gene_table[,1:24])
#0.1157791
sum(gene_table[which(gene_table[,25]=="Viridiplantae"),1:24])/sum(gene_table[,1:24])
#0.8551018

viridiplantae_class_list<-as.data.frame(table(gene_table$class[which(gene_table$kingdom=="Viridiplantae")],useNA="ifany"),stringsAsFactors=FALSE)[,1]
viridiplantae_class_relativeabundance_viridiplantae_df<-NULL
for(i in viridiplantae_class_list){
	viridiplantae_class_relativeabundance_viridiplantae_df<-rbind(viridiplantae_class_relativeabundance_viridiplantae_df,colSums(gene_table[intersect(which(gene_table[,27]==i),which(gene_table[,25]== "Viridiplantae")),1:24]))
}

rownames(viridiplantae_class_relativeabundance_viridiplantae_df)<-viridiplantae_class_list
viridiplantae_class_relativeabundance_viridiplantae<-as.data.frame(pivot_longer(as.data.frame(viridiplantae_class_relativeabundance_viridiplantae_df),col=colnames(viridiplantae_class_relativeabundance_viridiplantae_df),names_to="sample",values_to="abundance"))
viridiplantae_class_relativeabundance_viridiplantae$class<-unlist(lapply(viridiplantae_class_list,function(x) rep(x,24)))
viridiplantae_class_relativeabundance_viridiplantae<-cbind(viridiplantae_class_relativeabundance_viridiplantae,apply(sample_inform,2,function(x)rep(x,14)))

color<-random_color(14)
ggplot(viridiplantae_class_relativeabundance_viridiplantae, aes(x = sample, y = abundance))+geom_bar(aes(fill = class), position = "fill", stat = "identity")+ scale_fill_manual(values =color)+xlab(label = NULL)+theme(legend.title = element_text(size = 18, face = "bold"),legend.text = element_text(size = 16, color = "black"),axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5),axis.text.y = element_text(size = 16),axis.title = element_text(size = 20),strip.text.x = element_text(size = 18))+scale_y_continuous(breaks = c(0,0.25,0.5,0.75,1) ,labels = c("0%","25%","50%","75%","100%"))+ylab(label="Relative abundance (Viridiplantae count / total Viridiplantae count)")
ggsave("viridiplantae_class_relativeabundance_viridiplantae.pdf",height=12)
countplot_df<-as.data.frame(pivot_longer(as.data.frame(countmatrix),col=colnames(countmatrix),names_to="sample",values_to="abundance"))
ggplot(countplot_df)+geom_density(aes(abundance,colour =sample),adjust=5000)+xlab(label = NULL)+theme(legend.title = element_text(size = 18, face = "bold"),legend.text = element_text(size = 16, color = "black"),axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5),axis.text.y = element_text(size = 16),axis.title = element_text(size = 20),strip.text.x = element_text(size = 18))
ggsave("count_density.pdf",width=20,height=20)
fungi_order_list<-as.data.frame(table(gene_table$order[which(gene_table$kingdom=="Fungi")],useNA="ifany"),stringsAsFactors=FALSE)[,1]
fungi_order_relativeabundance_fungi_df<-NULL
for(i in fungi_order_list){
	fungi_order_relativeabundance_fungi_df<-rbind(fungi_order_relativeabundance_fungi_df,colSums(gene_table[intersect(which(gene_table[,28]==i),which(gene_table[,25]== "Fungi")),1:24]))
}

rownames(fungi_order_relativeabundance_fungi_df)<-fungi_order_list
fungi_order_relativeabundance_fungi<-as.data.frame(pivot_longer(as.data.frame(fungi_order_relativeabundance_fungi_df),col=colnames(fungi_order_relativeabundance_fungi_df),names_to="sample",values_to="abundance"))
fungi_order_relativeabundance_fungi$order<-unlist(lapply(fungi_order_list,function(x) rep(x,24)))
fungi_order_relativeabundance_fungi<-cbind(fungi_order_relativeabundance_fungi,apply(sample_inform,2,function(x)rep(x,27)))

color<-random_color(27)
ggplot(fungi_order_relativeabundance_fungi, aes(x = sample, y = abundance))+geom_bar(aes(fill = order), position = "fill", stat = "identity")+ scale_fill_manual(values =color)+xlab(label = NULL)+theme(legend.title = element_text(size = 18, face = "bold"),legend.text = element_text(size = 16, color = "black"),axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5),axis.text.y = element_text(size = 16),axis.title = element_text(size = 20),strip.text.x = element_text(size = 18))+scale_y_continuous(breaks = c(0,0.25,0.5,0.75,1) ,labels = c("0%","25%","50%","75%","100%"))+ylab(label="Relative abundance (Fungi count / total Fungi count)")
ggsave("fungi_order_relativeabundance_fungi.pdf",width=10,height=10)

fungi_order_relativeabundance_total<-as.data.frame(cbind(fungi_order_relativeabundance_fungi[,1],fungi_order_relativeabundance_fungi[,2]/colSums(countmatrix),fungi_order_relativeabundance_fungi[,3:6]))
colnames(fungi_order_relativeabundance_total)<- colnames(fungi_order_relativeabundance_fungi)
ggplot(fungi_order_relativeabundance_total, aes(x = sample, y = abundance))+geom_bar(aes(fill = order), position = "stack", stat = "identity")+ scale_fill_manual(values =color)+xlab(label = NULL)+theme(legend.title = element_text(size = 18, face = "bold"),legend.text = element_text(size = 16, color = "black"),axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5),axis.text.y = element_text(size = 16),axis.title = element_text(size = 20),strip.text.x = element_text(size = 18))+ scale_y_continuous(breaks = c(0, 0.0025, 0.005, 0.0075, 0.01) ,labels = c("0%","0.25%","0.5%","0.75%","1%"))+ylab(label="Relative abundance (Fungi count / total count)")
ggsave("fungi_order_relativeabundance_total.pdf",width=10,height=10)

CueifongLake_nm<-which(sample_inform[,1]=="CueifongLake")
Tsaopi_nm<-which(sample_inform[,1]=="Tsaopi")
HIGH_nm<-which(sample_inform[,2]=="HIGH")
LOW_nm<-which(sample_inform[,2]=="LOW")
megan_plant<-read.table("megan_plant")
megan_fungi<-read.table("megan_fungi")
plant_CueifongLake_count_matrix<-countmatrix[which(rownames(countmatrix)%in%megan_plant[,1]),CueifongLake_nm]
write.table(plant_CueifongLake_count_matrix,"lefse_input_plant_CueifongLake.txt",quote=FALSE,sep="\t")
plant_Tsaopi_count_matrix<-countmatrix[which(rownames(countmatrix)%in%megan_plant[,1]),Tsaopi_nm]
plant_Tsaopi_count_matrix<-plant_Tsaopi_count_matrix[which(rownames(plant_Tsaopi_count_matrix)%in%names(tail(sort(rowSums(plant_Tsaopi_count_matrix)),n=238380*0.6))),]
write.table(plant_Tsaopi_count_matrix,"lefse_input_plant_Tsaopi.txt",quote=FALSE,sep="\t")
fungi_CueifongLake_count_matrix<-countmatrix[which(rownames(countmatrix)%in%megan_fungi[,1]),CueifongLake_nm]
write.table(fungi_CueifongLake_count_matrix,"lefse_input_fungi_CueifongLake.txt",quote=FALSE,sep="\t")
fungi_Tsaopi_count_matrix<-countmatrix[which(rownames(countmatrix)%in%megan_fungi[,1]),Tsaopi_nm]
write.table(fungi_Tsaopi_count_matrix,"lefse_input_fungi_Tsaopi.txt",quote=FALSE,sep="\t")

